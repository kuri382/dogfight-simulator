<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="ja">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.14.0"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>ASRCAISim1: プラグインについて</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="clipboard.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript" src="cookie.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(function() { init_search(); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="asrc_doc_stylesheet.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">ASRCAISim1
   </div>
  </td>
    <td>        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <span id="MSearchSelect" class="search-icon" onmouseover="return searchBox.OnSearchSelectShow()" onmouseout="return searchBox.OnSearchSelectHide()"><span class="search-icon-dropdown"></span></span>
          <input type="text" id="MSearchField" value="" placeholder="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><div id="MSearchCloseImg" class="close-icon"></div></a>
          </span>
        </div>
</td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.14.0 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search/",'.html');
</script>
<script type="text/javascript">
$(function() { codefold.init(); });
</script>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(function(){initNavTree('a197997.html','',''); });
</script>
<div id="container">
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">プラグインについて </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>本シミュレータは、本体部分である <a class="el" href="a191708.html" title="Copyright (c) 2021-2025 Air Systems Research Center, Acquisition, Technology &amp; Logistics Agency(ATLA)">ASRCAISim1</a> パッケージを中心として、 プラグインとして様々な機能やモデルを追加できるような構成となっている。</p>
<p>プラグインは独立したパッケージとしてインストールされるものであり、 Pythonのエントリポイントの機能を用いて検索や読み込みが行われる。</p>
<p>プラグインは、本体の機能拡張としての位置づけを持つ"core plugin"と、 ユーザ定義モデルの追加としての位置づけを持つ"user plugin"の2種類に分類される。</p>
<p>本シミュレータに同梱されているプラグインの一覧は以下のリンク先のとおり。</p>
<ul>
<li><a class="el" href="a197996.html">core plugin</a></li>
<li><a class="el" href="a197998.html">user plugin</a></li>
</ul>
<h1 class="doxsection"><a class="anchor" id="section_plugin_import"></a>
プラグインのインポート</h1>
<h2 class="doxsection"><a class="anchor" id="section_plugin_core_plugin_import"></a>
core pluginのインポート</h2>
<p>デフォルトでは、core pluginは本体部分のインポートと同時にインポートされる。 この自動インポートは、環境変数で"ASRCAISim1_disable_automatic_import_of_core_plugins"=1とすることで無効化できる。</p>
<p>また、core pluginは本体部分と透過的にマージされているように呼び出すことも可能である。 例えば、AAAというcore pluginがあった場合、通常はAAA.BBBとして参照されるオブジェクトは、 ASRCAISim1.BBBという形で本体部分のattributeとしても参照可能となっている。</p>
<p>あるいは、ASRCAISim1.plugins.AAA.BBBという形でプラグイン名を明示した参照も可能であり、 当然ながら単にAAA.BBBという直接参照も可能である。</p>
<h2 class="doxsection"><a class="anchor" id="section_plugins_user_plugin_import"></a>
user pluginのインポート</h2>
<p>user_pluginはユーザ自身が明示的にインポートする必要がある。 ただし、<a class="el" href="a198008.html#section_simulation_Factory_resolveModelConfig">Factoryによるクラス・モデルの検索</a>が行われる際には、 "PluginName.ClassName"のような形で"."区切りでクラス名等を指定していれば該当するプラグインが自動的にインポートされる。</p>
<h1 class="doxsection"><a class="anchor" id="section_plugins_namespace"></a>
C++側の名前空間</h1>
<p>本シミュレータにおけるC++側の名前空間の命名規則は以下の通りである。</p>
<p>本体部分及びcore pluginは <a class="el" href="a191695.html">asrc::core</a> 名前空間を用いる。</p>
<p>user pluginはプラグイン名(=パッケージ名)と同名の名前空間を用いる。 ソースコード中では、 ASRC_PLUGIN_NAMESPACE_BEGIN と ASRC_PLUGIN_NAMESPACE_END という2つのマクロで囲むことで自動的に適切な名前空間が設定される。</p>
<h1 class="doxsection"><a class="anchor" id="section_plugin_creation"></a>
プラグインの作成方法</h1>
<p>sample/modules以下に、二つのひな形を同梱しているので、これらをベースに 独自のソースコードを追加していくことを推奨する。</p>
<ul>
<li><a class="elRef" href="../cpp_template/index.html#mainpage_cpp_template">cpp_template</a>…C++を用いて独自プラグインを作成するためのひな形。Pythonクラスも追加可能。</li>
<li><a class="elRef" href="../py_template/index.html#mainpage_py_template">py_template</a>…Pythonのみを用いて独自プラグインを作成するためのひな形</li>
</ul>
<h2 class="doxsection"><a class="anchor" id="section_plugins_add_dependency"></a>
依存パッケージ、プラグインの追加</h2>
<h3 class="doxsection"><a class="anchor" id="section_plugins_add_third_party_python_dependency"></a>
外部Pythonパッケージの追加</h3>
<p>外部Pythonパッケージに依存する場合は、 ビルド時に必要なものはpyproject.tomlの[build-system]ブロックのrequiresに、 インストール後の使用時に必要なものはpyproject.tomlの[project]ブロックのdependenciesに書く。 </p><div class="fragment"><div class="line">[build-system]</div>
<div class="line">requires =[</div>
<div class="line">    &quot;YourDependencyInBuild&quot;</div>
<div class="line">]</div>
<div class="line">[project]</div>
<div class="line">dependencies=[</div>
<div class="line">    &quot;YourDependencyInUse&quot;</div>
<div class="line">]</div>
</div><!-- fragment --><h3 class="doxsection"><a class="anchor" id="section_plugins_add_plugin_dependency"></a>
本シミュレータのプラグインの追加</h3>
<p>本シミュレータの他のプラグインに依存する場合は、 ビルド時に必要なものはpyproject.tomlの[build-system]ブロックのrequiresに、 インストール後の使用時に必要なものはpyproject.tomlの[project]ブロックのdependenciesに書く。</p>
<p>さらに、pyproject.tomlの[tool.ASRCAISim1]ブロックにおいて、 依存プラグインがcore pluginの場合はcore-pluginsに追記し、 user pluginの場合はuser-pluginsに追記する。</p>
<h3 class="doxsection"><a class="anchor" id="section_plugins_add_third_party_cpp_dependency"></a>
外部のC++ライブラリの追加</h3>
<p>sample/modules/cpp_templateディレクトリにおいて、 外部のC++ライブラリをビルドして同梱してインストールするひな形を提供している。</p>
<p>このひな形を用いると、プラグインのインストール時に、 プラグインのパッケージディレクトリ直下にthirdPartyという名前のディレクトリが追加され、 ここに各ライブラリのビルド結果を格納していく形となる。 (サブディレクトリ構造は使用するライブラリによって異なる。) </p><div class="fragment"><div class="line">cpp_template</div>
<div class="line">└thirdParty</div>
<div class="line">　├include # ヘッダファイルを格納</div>
<div class="line">　├lib # .soファイルを格納</div>
<div class="line">　└share/cmake # xxxConfig.cmakeファイルを格納</div>
</div><!-- fragment --><p>主に以下のファイルに追記することで外部ライブラリのビルド・インストール処理を記述していく。 なお、本シミュレータの本体部分も同様の方法で外部ライブラリを使用しているので、記述方法の具体例はそちらを参考にされたい。</p>
<ul>
<li><p class="startli">thirdParty/scripts/fetcher.sh</p>
<p class="startli">外部ライブラリのダウンロード処理を記述する。 ダウンロード先はthirdParty/deps/を想定している。</p>
</li>
<li><p class="startli">thirdParty/scripts/extractor.sh</p>
<p class="startli">ダウンロードしたファイルの展開処理を記述する。 展開先はthirdParty/depsを想定している。</p>
</li>
<li><p class="startli">thirdParty/scripts/builder.sh</p>
<p class="startli">展開したファイルのビルド処理を記述する。 ビルドディレクトリは build/[Release|Build]/thirdParty、 単体での一時インストール先は build/[Release|Build]/thirdParty/install を想定している。</p>
</li>
<li><p class="startli">thirdParty/scripts/cleaner.sh</p>
<p class="startli">clean時の処理を記述する。 ダウンロード・展開したファイルを削除したい場合は削除する。 使いまわしたい場合は何も書かなくてもよい。</p>
</li>
<li><p class="startli">CMakeLists.txt</p>
<p class="startli">末尾のコメントアウトされている部分を参考に、 外部ライブラリのリンク処理を記述する。 </p><div class="fragment"><div class="line">find_package(a_third_party_package REQUIRED)</div>
<div class="line">target_link_libraries(${CMAKE_PROJECT_NAME} PRIVATE</div>
<div class="line">    a_third_party_package::target</div>
<div class="line">)</div>
</div><!-- fragment --><p class="startli">なお、このひな形では、build/[Release|Build]/thirdParty/install/以下に インストールされたファイルをcpp_template/thirdParty/以下にコピー することで最終生成物を生成する。</p>
</li>
<li><p class="startli">thirdParty/scripts/thirdPartyConfigPath.cmake</p>
<p class="startli">このプラグインをリンクする際に、このプラグインの依存ライブラリもリンクするための cmake configを記述する。</p>
<p class="startli">cpp_template/thirdParty/以下にインストールされたxxxConfig.cmakeを cmakeが見つけられるように、該当するディレクトリを CMAKE_PREFIX_PATH に追加すること。</p>
</li>
</ul>
<h2 class="doxsection"><a class="anchor" id="section_plugins_core_and_user"></a>
core pluginとuser plugin の選択</h2>
<p>各プラグインをcore pluginとuser pluginのどちらとして扱うかについては、 pyproject.tomlの[tool.ASRCAISim1]ブロックにおいて "is-core-plugin"オプションをTrue/Falseで指定することで切り替えることができる。</p>
<p>前述のひな形はいずれもuser pluginとしてのひな形であり、もしこれをcore pluginにする場合は、 名前空間も <a class="el" href="#section_plugins_namespace">これ</a> に従うこと。</p>
<p>なお、core pluginは"ASRCAISim1.core_plugins"グループ、user pluginは"ASRCAISim1.user_plugins"グループとして エントリポイントが登録される。</p>
<h2 class="doxsection"><a class="anchor" id="section_plugins_build_identification"></a>
user pluginの複数バージョンを混在させる方法</h2>
<p>user pluginは、Python環境にインストール可能なバージョンは一つのみであるが、 他のPythonパッケージのサブパッケージとして配置することで、 異なるバージョンの同名プラグインを別々に読み込むことが可能となっている。</p>
<p>この機能は、pyproject.tomlの[tool.ASRCAISim1]ブロックにおいて "enable-build-identification"オプションをTrueにしてビルドすることで有効化できる。</p>
<p>この機能は、BuildIdentifierというビルドバージョンを表す文字列 (現バージョンにおいてはビルド日時を用いて"B"+"YYYYmmddHHMMSS"としている) によってインポート対象のプラグインを識別することによって実現される。</p>
<p>C++部分のソースコードは名前空間を ASRC_PLUGIN_NAMESPACE_BEGIN と ASRC_PLUGIN_NAMESPACE_END という2つのマクロで囲んでいれば、&lt;plugin name&gt;::&lt;BuildIdentifier&gt;という名前空間が自動的に作られ、 名称の衝突が回避される。</p>
<p>なお、一部分をビルドバージョンに依存しない共通の実装としたい場合には、該当部分の名前空間の開閉マクロを ASRC_PLUGIN_BII_NAMESPACE_BEGIN と ASRC_PLUGIN_BII_NAMESPACE_END に変更すればよい。 </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<div id="page-nav" class="page-nav-panel">
<div id="page-nav-resize-handle"></div>
<div id="page-nav-tree">
<div id="page-nav-contents">
</div><!-- page-nav-contents -->
</div><!-- page-nav-tree -->
</div><!-- page-nav -->
</div><!-- container -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.14.0 </li>
  </ul>
</div>
</body>
</html>
