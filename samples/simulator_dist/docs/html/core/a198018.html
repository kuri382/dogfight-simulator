<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="ja">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.14.0"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>ASRCAISim1: 独自 Agent の実装方法</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="clipboard.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript" src="cookie.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(function() { init_search(); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="asrc_doc_stylesheet.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">ASRCAISim1
   </div>
  </td>
    <td>        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <span id="MSearchSelect" class="search-icon" onmouseover="return searchBox.OnSearchSelectShow()" onmouseout="return searchBox.OnSearchSelectHide()"><span class="search-icon-dropdown"></span></span>
          <input type="text" id="MSearchField" value="" placeholder="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><div id="MSearchCloseImg" class="close-icon"></div></a>
          </span>
        </div>
</td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.14.0 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search/",'.html');
</script>
<script type="text/javascript">
$(function() { codefold.init(); });
</script>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(function(){initNavTree('a198018.html','',''); });
</script>
<div id="container">
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">独自 Agent の実装方法 </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>独自の <a class="el" href="a192877.html" title="Asset のうち、行動判断を行う主体としてシミュレータ外部とObservation,Actionを入出力するものを表すクラス">Agent</a> クラスを実装する場合の大まかな流れは以下の通りである。</p>
<ol type="1">
<li>単一の <a class="el" href="a193313.html" title="Asset のうち物理的実体を持つものを表すクラス">PhysicalAsset</a> を対象とする場合は <a class="el" href="a192901.html">SingleAssetAgent</a> クラスを、それ以外の場合は Agentクラスを継承する。</li>
<li>Observation と Action の形式を決め、 <a class="el" href="a192877.html#a6914e2ee1bb8c120b92187632473d434">observation_space</a>関数と <a class="el" href="a192877.html#aa8ea1bb1f32de8fb7823591987cd9362">action_space</a>関数をオーバーライドする。</li>
<li>observables から Observation を生成する<a class="el" href="a192877.html#a94019ee102d37aadbc6402af61483c2f">makeObs</a>関数と、 Action から decision と commands を生成する<a class="el" href="a192877.html#ae0615744f84360d505d44d787ab5a574">deploy</a>関数をオーバーライドする。 このとき、これらの関数だけでは難しくより細かい周期で処理する必要がある場合も想定されるため、 必要に応じて <a class="el" href="a192877.html#ac936eebd134b6d7c02c1b682efc6ae4a">perceive</a>、 <a class="el" href="a192877.html#ad6d8f6f2a261cb54d267f921136f3c7a">control</a>、 <a class="el" href="a192877.html#a71889dcf362d1199850b7307dd6b3427">behave</a>関数をオーバーライドする。</li>
<li>modelConfig として設定可能とするパラメータを選択し、他の登場物に依存する初期化処理が 必要な場合は<a class="el" href="a193097.html#a8c536cec1e455c8d54dfe5eae0c53dbc">validate</a>関数もオーバーライドし、初期化処理を記述する。</li>
<li>模倣学習を使用する場合は、模倣対象として想定する <a class="el" href="a192877.html" title="Asset のうち、行動判断を行う主体としてシミュレータ外部とObservation,Actionを入出力するものを表すクラス">Agent</a> クラスの decision と commands から、 自身の action_space の中で最も類似している Action を計算する<a class="el" href="a192877.html#a35aed2e3a8372bc33c4a1c32752a8cd8">convertActionFromAnother</a>関数を オーバーライドする。また、<a class="el" href="a192877.html#ad6d8f6f2a261cb54d267f921136f3c7a">control</a> 関数の中身を模倣対象の <a class="el" href="a198021.html#section_training_imitation_common_decision_format">decision</a> と commands に応じて変更したい場合、 <a class="el" href="a192877.html#a89786b957288e0dccb2c397a45c99adb">controlWithAnotherAgent</a>関数をオーバーライドする。</li>
<li>メンバ変数 observables と commands が適切に計算されているかを確認する。特に、このクラスが 模倣される側となることを想定する場合は observables に decision が含まれていることを確認する。</li>
<li>C++で実装した場合、pybind11 を用いて Python 側へ公開する。</li>
<li><a class="el" href="a193125.html" title="Entityの生成を行うクラス。">Factory</a> へクラスを登録する処理をどのタイミングで実行するかを決定する。 インポート時に呼ばれるように記述してもよいし、ユーザーがインポート後に手動で登録するものとしてもよい。</li>
<li>json ファイル等を用意して modelConfig を記述し、Factory にモデル登録ができるようにする。 このとき、<a class="el" href="a192877.html#ac936eebd134b6d7c02c1b682efc6ae4a">perceive</a>、<a class="el" href="a192877.html#ad6d8f6f2a261cb54d267f921136f3c7a">control</a>、<a class="el" href="a192877.html#a71889dcf362d1199850b7307dd6b3427">behave</a> をオーバーライドした場合であって、1[tick]ごとではない処理周期としたい場合には、 <a class="el" href="a198006.html#section_simulation_entity_dependency">こちら</a>に従い modelConfig に処理周期に関する記述を追加する。</li>
<li>以上により、 <a class="el" href="a193525.html" title="gymnasium(OpenAI gym)のEnvとしてのインターフェースを持ったシミュレーション実行管理クラスの具象クラス。">SimulationManager</a> の config["AgentConfigDispatcher"]に登録したモデル名を指す alias 要素を記述することで独自の <a class="el" href="a192877.html" title="Asset のうち、行動判断を行う主体としてシミュレータ外部とObservation,Actionを入出力するものを表すクラス">Agent</a> が使用可能となる。</li>
</ol>
<h1 class="doxsection"><a class="anchor" id="autotoc_md10"></a>
Python クラスとして Agent クラスを実装する際のひな形</h1>
<p>Python クラスとして <a class="el" href="a192877.html" title="Asset のうち、行動判断を行う主体としてシミュレータ外部とObservation,Actionを入出力するものを表すクラス">Agent</a> クラスを実装する際のひな形を以下に示す。</p>
<div class="fragment"><div class="line"><span class="keyword">class </span>UserAgent(Agent): <span class="comment"># Agent の代わりに SingleAssetAgent を継承してもよい</span></div>
<div class="line">    <span class="keyword">def </span>__init__(self, modelConfig: nljson, instanceConfig: nljson):</div>
<div class="line">        super().__init__(modelConfig, instanceConfig)</div>
<div class="line">        if(self.isDummy):</div>
<div class="line">            <span class="keywordflow">return</span> <span class="comment">#Factory によるダミー生成のために空引数でのインスタンス化に対応させる</span></div>
<div class="line">        <span class="comment"># 以上 3 行の呼び出しは原則として必須である。</span></div>
<div class="line"> </div>
<div class="line">        <span class="comment">#modelConfig から値を取得する場合、直接[]でアクセスすると nljson 型で得られる。</span></div>
<div class="line">        <span class="comment">#Python のプリミティブ型にするためには()を付けて__call__を呼ぶ必要がある。</span></div>
<div class="line">        self.hoge = self.modelConfig[<span class="stringliteral">&quot;hoge&quot;</span>]()</div>
<div class="line">        <span class="comment"># getValueFromJsonKRD()等のユーティリティを用いて</span></div>
<div class="line">        <span class="comment"># 確率的な選択やデフォルト値の設定も可能。</span></div>
<div class="line">        <span class="comment"># その場合の出力は Python プリミティブ型となるため()の付加は不要。</span></div>
<div class="line">        <span class="comment"># 現バージョンでは乱数生成器には std::mt19937 しか使用できないが、</span></div>
<div class="line">        <span class="comment"># self.randomGen として基底クラスで予め生成されているためこれを使用する。</span></div>
<div class="line"> </div>
<div class="line">        self.withRandom = getValueFromJsonKR(self.modelConfig,<span class="stringliteral">&quot;R&quot;</span>,self.randomGen)</div>
<div class="line">        defaultValue = 1234</div>
<div class="line">        self.withDefault = getValueFromJsonKD(self.modelConfig, <span class="stringliteral">&quot;D&quot;</span>, defaultValue)</div>
<div class="line">        self.withRandomAndDefault = getValueFromJsonKRD(self.modelConfig, <span class="stringliteral">&quot;RD&quot;</span>, self.randomGen, defaultValue)</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">def </span>action_space(self) -&gt; gym.spaces.Space:</div>
<div class="line">        <span class="comment"># 行動空間の定義(必須)</span></div>
<div class="line">        <span class="keywordflow">return</span> gym.spaces.MultiDiscrete([3,3,3,3]) <span class="comment">#所要の Space を返す。</span></div>
<div class="line"> </div>
<div class="line">    <span class="keyword">def </span>observation_space(self) -&gt; gym.spaces.Space:</div>
<div class="line">        <span class="comment"># 状態空間の定義(必須)</span></div>
<div class="line">        <span class="keywordflow">return</span> gym.space.Box(low=0.0, high=1.0, shape=(100,)) <span class="comment">#所要の Space を返す。</span></div>
<div class="line"> </div>
<div class="line">    <span class="keyword">def </span>makeObs(self) -&gt; object:</div>
<div class="line">        <span class="comment"># Observation の生成(必須)</span></div>
<div class="line"> </div>
<div class="line">        <span class="comment">#各種時刻情報の取得方法</span></div>
<div class="line">        time = self.manager.getTime() <span class="comment">#現在時刻(秒単位)</span></div>
<div class="line">        tick = self.manager.getTickCount() <span class="comment">#現在時刻(tick 単位)</span></div>
<div class="line">        stepCount = self.getStepCount() <span class="comment">#自身の行動判断ステップ数</span></div>
<div class="line">        stepInterval = self.getStepInterval() <span class="comment">#自身の行動判断周期(tick 単位)</span></div>
<div class="line">        baseTimeStep = self.manager.getBaseTimeStep() <span class="comment">#1tick あたりの秒数</span></div>
<div class="line"> </div>
<div class="line">        <span class="comment">#Ruler の情報の取得方法</span></div>
<div class="line">        ruler = self.manager.getRuler()() <span class="comment">#getRuler()で RulerAccessor 型の weak_ptr が</span></div>
<div class="line">                                          <span class="comment">#得られるため、更に()で本体を取得する</span></div>
<div class="line">        rulerObs = ruler.observables <span class="comment">#nljson 型で得られる</span></div>
<div class="line"> </div>
<div class="line">        <span class="comment">#parent の情報の取得方法</span></div>
<div class="line">        <span class="comment">#(1)SingleAssetAgent から継承した場合、self.parent を使用する。</span></div>
<div class="line">        parentObs = self.parent.observables <span class="comment">#nljson 型で得られる</span></div>
<div class="line">        motion = MotionState(parentObs[<span class="stringliteral">&quot;motion&quot;</span>]) <span class="comment">#運動情報は MotionState として取得する</span></div>
<div class="line">        missiles = [m <span class="keywordflow">for</span> m <span class="keywordflow">in</span> parentObs[<span class="stringliteral">&quot;weapon&quot;</span>][<span class="stringliteral">&quot;missiles&quot;</span>]] <span class="comment">#誘導弾情報</span></div>
<div class="line">        tracks = [Track3D(t) <span class="keywordflow">for</span> t <span class="keywordflow">in</span> parentObs[<span class="stringliteral">&quot;sensor&quot;</span>][<span class="stringliteral">&quot;track&quot;</span>]] <span class="comment">#彼機航跡情報</span></div>
<div class="line">        mws = [Track2D(t) <span class="keywordflow">for</span> t <span class="keywordflow">in</span> parentObs[<span class="stringliteral">&quot;sensor&quot;</span>][<span class="stringliteral">&quot;mws&quot;</span>][<span class="stringliteral">&quot;track&quot;</span>]] <span class="comment">#MWS 情報</span></div>
<div class="line"> </div>
<div class="line">        <span class="comment">#(2)Agent から継承した場合、dict 型の self.parents を使用する。</span></div>
<div class="line">        <span class="keywordflow">for</span> parentFullName, parent <span class="keywordflow">in</span> self.parents.items():</div>
<div class="line">            parentObs = parent.observables <span class="comment">#nljson 型で得られる</span></div>
<div class="line">            <span class="keywordflow">if</span> (parentObs[<span class="stringliteral">&quot;isAlive&quot;</span>]()): <span class="comment"># 複数のparentsがいる場合、生存していない可能性がある。</span></div>
<div class="line">                                         <span class="comment"># 生存していないparentはほとんどのobservablesが無効になっているため、</span></div>
<div class="line">                                         <span class="comment"># 適切に処理を分岐する必要がある。</span></div>
<div class="line">                <span class="keywordflow">pass</span></div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">return</span> np.zeros([100]) <span class="comment">#observables を加工し、所要の Observation を返す。</span></div>
<div class="line"> </div>
<div class="line">    <span class="keyword">def </span>deploy(self,action: object):</div>
<div class="line">        <span class="comment">#Action の解釈と decision and/or commands の生成 (1step に 1 回実行)(必須)</span></div>
<div class="line"> </div>
<div class="line">        <span class="comment">#decision は Agent 自身の observables の一部として記述する。</span></div>
<div class="line">        <span class="comment">#使用しない場合は省略しても差し支えない。</span></div>
<div class="line">        self.observables[self.parent.getFullName()][<span class="stringliteral">&quot;decision&quot;</span>]={</div>
<div class="line">            <span class="stringliteral">&quot;Roll&quot;</span>:[<span class="stringliteral">&quot;Don’t care&quot;</span>],</div>
<div class="line">            <span class="stringliteral">&quot;Horizontal&quot;</span>:[<span class="stringliteral">&quot;Az_BODY&quot;</span>,0.0],</div>
<div class="line">            <span class="stringliteral">&quot;Vertical&quot;</span>:[<span class="stringliteral">&quot;El&quot;</span>,0.0],</div>
<div class="line">            <span class="stringliteral">&quot;Throttle&quot;</span>:[<span class="stringliteral">&quot;Vel&quot;</span>,300.0],</div>
<div class="line">            <span class="stringliteral">&quot;Fire&quot;</span>:[<span class="keyword">False</span>,Track3D()]</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">def </span>validate(self):</div>
<div class="line">        <span class="comment">#コンストラクタ外の初期化処理(必須ではない)</span></div>
<div class="line">        <span class="comment">#ruler や parent の observables に依存するものがあるような場合を想定している。</span></div>
<div class="line">        <span class="keywordflow">pass</span></div>
<div class="line"> </div>
<div class="line">    <span class="keyword">def </span>perceive(self):</div>
<div class="line">        <span class="comment">#より細かい tick 単位の処理(perceive)を記述(必須ではない)</span></div>
<div class="line">        <span class="comment">#decision and/or commands の複雑な生成処理を行う場合等に用いる。</span></div>
<div class="line">        <span class="keywordflow">pass</span></div>
<div class="line"> </div>
<div class="line">    <span class="keyword">def </span>control(self):</div>
<div class="line">        <span class="comment">#1tick 単位の処理(control)を記述(必須ではない)</span></div>
<div class="line">        <span class="comment">#decision and/or commands の複雑な生成処理を行う場合等に用いる。</span></div>
<div class="line">        <span class="comment">#commands は deploy で計算してもよいが、control でより高頻度に計算してもよい。</span></div>
<div class="line">        self.commands[self.parent.getFullName()] = {</div>
<div class="line">            <span class="stringliteral">&quot;motion&quot;</span>: { <span class="comment">#機動の指定。以下の指定方法は一例。</span></div>
<div class="line">                <span class="stringliteral">&quot;dstDir&quot;</span>: np.array([1.0, 0.0, 0.0]), <span class="comment">#進みたい方向を指定</span></div>
<div class="line">                <span class="stringliteral">&quot;dstV&quot;</span>: 300.0 <span class="comment">#進みたい速度を指定</span></div>
<div class="line">            },</div>
<div class="line">            <span class="stringliteral">&quot;weapon&quot;</span>: {</div>
<div class="line">                <span class="stringliteral">&quot;launch&quot;</span>: <span class="keyword">False</span>, <span class="comment">#射撃要否を bool で指定</span></div>
<div class="line">                <span class="stringliteral">&quot;target&quot;</span>: Track3D().to_json() <span class="comment">#射撃目標の Track3D を json 化して指定</span></div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">def </span>behave(self):</div>
<div class="line">        <span class="comment">#1tick 単位の処理(behave)を記述(必須ではない)</span></div>
<div class="line">        <span class="comment">#decision and/or commands の複雑な生成処理を行う場合等に用いる。</span></div>
<div class="line">        <span class="keywordflow">pass</span></div>
</div><!-- fragment --> </div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<div id="page-nav" class="page-nav-panel">
<div id="page-nav-resize-handle"></div>
<div id="page-nav-tree">
<div id="page-nav-contents">
</div><!-- page-nav-contents -->
</div><!-- page-nav-tree -->
</div><!-- page-nav -->
</div><!-- container -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.14.0 </li>
  </ul>
</div>
</body>
</html>
