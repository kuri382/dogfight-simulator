<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="ja">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.14.0"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>ASRCAISim1: シミュレータの生成及び外部インターフェース</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="clipboard.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript" src="cookie.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(function() { init_search(); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="asrc_doc_stylesheet.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">ASRCAISim1
   </div>
  </td>
    <td>        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <span id="MSearchSelect" class="search-icon" onmouseover="return searchBox.OnSearchSelectShow()" onmouseout="return searchBox.OnSearchSelectHide()"><span class="search-icon-dropdown"></span></span>
          <input type="text" id="MSearchField" value="" placeholder="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><div id="MSearchCloseImg" class="close-icon"></div></a>
          </span>
        </div>
</td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.14.0 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search/",'.html');
</script>
<script type="text/javascript">
$(function() { codefold.init(); });
</script>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(function(){initNavTree('a198010.html','',''); });
</script>
<div id="container">
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">シミュレータの生成及び外部インターフェース </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1 class="doxsection"><a class="anchor" id="section_simulation_execution_SimulationManager"></a>
SimulationManager クラス</h1>
<p>本シミュレータにおいてシミュレーションの実行管理を行うオブジェクトは <a class="el" href="a193525.html" title="gymnasium(OpenAI gym)のEnvとしてのインターフェースを持ったシミュレーション実行管理クラスの具象クラス。">SimulationManager</a> クラスである。</p>
<p>本シミュレータは主に強化学習用環境として用いる想定で作成されているため、 <a class="el" href="a198011.html#section_simulation_flow">こちら</a>に記載のとおり、 gymnasium.Env のインターフェースに沿って<a class="el" href="a193525.html#ab0d9d3a47df9dc19dcdc16eb5a21a08a">reset</a>と<a class="el" href="a193525.html#ad3eb5f6c74a65da18461bf5b89db6d00">step</a> の繰り返しによりシミュレーションが進行する。</p>
<h2 class="doxsection"><a class="anchor" id="section_simulation_execution_SimulationManager_constructor"></a>
コンストラクタ</h2>
<p><a class="el" href="a193525.html" title="gymnasium(OpenAI gym)のEnvとしてのインターフェースを持ったシミュレーション実行管理クラスの具象クラス。">SimulationManager</a> のコンストラクタ引数は以下の4つである。</p><ul>
<li><p class="startli">const nl::json&amp; config_</p>
<p class="startli">コンフィグ。json object(dict)で与える。書式は<a class="el" href="#section_simulation_execution_SimulationManager_config_format">後述</a>。</p>
</li>
<li><p class="startli">const std::int32_t&amp; worker_index_</p>
<p class="startli">worker indexを指定する。プロセス中の全 <a class="el" href="a193081.html" title="Entity の生成・管理を行うクラス。">EntityManager</a> インスタンスに影響する。</p>
</li>
<li><p class="startli">const std::int32_t&amp; vector_index_</p>
<p class="startli">vector indexを指定する。</p>
</li>
<li><p class="startli">std::function&lt;nl::json(const nl::json&amp;,const std::int32_t&amp;,const std::int32_t&amp;)&gt; overrider_</p>
<p class="startli">config_ の内容を worker_index_ と vector_index_ の内容に応じてオーバーライドしたい場合、 その処理を行う関数オブジェクトを与える。省略可。</p>
</li>
</ul>
<h2 class="doxsection"><a class="anchor" id="section_simulation_execution_SimulationManager_config_format"></a>
コンフィグの書式</h2>
<p>config_の形式は、 doc/src/format/SimulationManager_config.json のとおりであるが、 必ずしも完全な形のjson objectを直接与える必要はなく、 以下のように細分化したjsonファイルやjson objectを組み合わせて自動構成することができる。</p>
<ul>
<li><p class="startli">ファイルパスで指定</p>
<p class="startli">jsonファイルの中身をそのまま採用する。</p>
</li>
<li><p class="startli">json objectで指定</p>
<p class="startli">json objectをそのまま採用する。</p>
</li>
<li><p class="startli">ファイルパス又はjson objectのリストで指定</p>
<p class="startli">先頭要素から順にmerge patchでマージしたものを採用する。</p>
</li>
</ul>
<p>マージ後の完全な形のconfig_は以下のような形となる。 </p><div class="fragment"><div class="line">/**</div>
<div class="line"> * Copyright (c) 2021-2025 Air Systems Research Center, Acquisition, Technology &amp; Logistics Agency(ATLA)</div>
<div class="line"> * @file</div>
<div class="line"> * </div>
<div class="line"> * @brief SimulationManagerクラスのコンストラクタに与えるconfigのフォーマットに関する説明</div>
<div class="line"> */</div>
<div class="line">{</div>
<div class="line">    &quot;Manager&quot;: {</div>
<div class="line">        &quot;seed&quot;: int, // 乱数のシード値(uint32_t)</div>
<div class="line">        &quot;measureTime&quot;: bool=false, // 各phaseの処理時間を計測するかどうか</div>
<div class="line">        &quot;numThreads&quot;: int=1, // スレッド数(基本的には1を推奨)</div>
<div class="line">        &quot;skipNoAgentStep&quot;: bool=true, // 誰も行動しないstepのreturnを省略するかどうか</div>
<div class="line">        &quot;enableStructuredReward&quot;: bool=false, // 報酬をいくつかのグループに分けたdictとするかどうか</div>
<div class="line">        &quot;exposeDeadAgentReward&quot;: bool=true, // 生存していないAgentへの報酬を出力し続けるかどうか</div>
<div class="line">        &quot;delayLastObsForDeadAgentUntilAllDone&quot;: bool=true, // 生存状態がfalseとなったAgentに関するstepのreturnをエピソード終了時まで遅延するかどうか</div>
<div class="line"> </div>
<div class="line">        &quot;Epoch&quot;: dict, // 基準時刻の設定。省略時は2000-01-01T12-00-00 in TTとなる。</div>
<div class="line">        &quot;TimeStep&quot;: {</div>
<div class="line">            &quot;baseTimeStep&quot;: float=0.1, // 1 tickあたりの秒数</div>
<div class="line">            &quot;defaultAgentStepInterval&quot;: int=1 // Agentのデフォルトの行動判断周期(tick単位)</div>
<div class="line">        },</div>
<div class="line"> </div>
<div class="line">        &quot;CoordinateReferenceSystem&quot;: {</div>
<div class="line">            &quot;preset&quot;: dict, // 初期化時に生成するCRSを列挙する。</div>
<div class="line">                            // キーが各CRSのfull nameとなる。</div>
<div class="line">                            // 値は通常のEntity生成用コンフィグ(doc/format/Entity_creation_config.json)を記述すればよい。</div>
<div class="line">                            // なお、ここではisEpisodicとbaseNameは省略可能(自動設定されるため)</div>
<div class="line">            &quot;root&quot;: { // 基準座標系を指定する。省略時はPureFlatCRSとなる。</div>
<div class="line"> </div>
<div class="line">                // (推奨) presetから選択する場合は&quot;entityFullName&quot;を指定する。</div>
<div class="line">                &quot;entityFullName&quot;: str,</div>
<div class="line"> </div>
<div class="line">                // (非推奨) 直接生成する場合は以下の例のように通常のEntity生成用コンフィグ(doc/format/Entity_creation_config.json)を記述すればよい。</div>
<div class="line">                // ただし、ここではisEpisodicとbaseNameは省略不可能</div>
<div class="line">                &quot;class&quot;: &quot;PureFlatCRS&quot;,</div>
<div class="line">                &quot;config&quot;: {}</div>
<div class="line">            }</div>
<div class="line">        },</div>
<div class="line">        &quot;ViewerType&quot;: str=&quot;None&quot;, // Viewer のモデル名</div>
<div class="line">        &quot;Ruler&quot;: str or dict, // Ruler のモデル名 又は Ruler を生成するための json object(doc/format/Entity_creation_config.json)</div>
<div class="line">        &quot;Rewards&quot;: [ // Reward モデルと計算対象 Agent のリスト</div>
<div class="line">            {</div>
<div class="line">                &quot;model&quot;: str, // Reward のモデル名</div>
<div class="line">                &quot;target&quot;: str or list[str] // 計算対象のAgentの指定。</div>
<div class="line">                                           // &quot;All&quot;、&quot;Team:&lt;team&gt;&quot;、&quot;Agent:&lt;agent full name&gt;&quot;を組み合わせて指定する。</div>
<div class="line">                                           // &lt;team&gt;と&lt;agent full name&gt;は正規表現で指定可能。</div>
<div class="line">            }</div>
<div class="line">        ],</div>
<div class="line">        &quot;Callbacks&quot;: dict, // 一般のCallback</div>
<div class="line">                           // キーが各Callbackのfull nameとなる。</div>
<div class="line">                           // 値は クラス名 + model config による指定 又は モデル名 による指定のみに対応。</div>
<div class="line">        &quot;Loggers&quot;: dict, // Logger</div>
<div class="line">                         // キーが各Loggerのfull nameとなる。</div>
<div class="line">                         // 値は クラス名 + model config による指定 又は モデル名 による指定のみに対応。</div>
<div class="line"> </div>
<div class="line">        &quot;Assets&quot;: { // PhysicalAsset の生成コンフィグを記述する。 ConfigDispatcher により展開される。</div>
<div class="line"> </div>
<div class="line">        },</div>
<div class="line">        &quot;AssetConfigDispatcher&quot;: { // PhysicalAsset の生成用の ConfigDispatcher の初期化用コンフィグを記述する。</div>
<div class="line">        },</div>
<div class="line">        &quot;AgentConfigDispather&quot;: { // Agent の生成用の ConfigDispatcher の初期化用コンフィグを記述する。</div>
<div class="line"> </div>
<div class="line">        },</div>
<div class="line"> </div>
<div class="line">        // 以下は通常は指定不要。</div>
<div class="line">        &quot;uuid&quot;: str, // UUIDを指定したい場合のみ、それを表す文字列を記述する。</div>
<div class="line">        &quot;episode_index&quot;: int // 生成時点でのepisode indexを指定したい場合、その値を記述する。</div>
<div class="line">    },</div>
<div class="line">    &quot;Factory&quot;: dict // Factory::addModelConfigsFromJson に与えることのできるjson object(doc/format/Factory_add_model_config.json)</div>
<div class="line">}</div>
</div><!-- fragment --><h2 class="doxsection"><a class="anchor" id="section_simulation_execution_asset_config_dispatch"></a>
PhysiacalAsset の生成について</h2>
<p>エピソード初期化時の <a class="el" href="a193313.html" title="Asset のうち物理的実体を持つものを表すクラス">PhysicalAsset</a> 生成は、 <a class="el" href="a198003.html">ConfigDispatcherによる再帰的な変換</a> 機能を用いて実現している。</p>
<p>config_["/Manager/AssetConfigDispatcher"]をaliasesとして <a class="el" href="a198003.html">ConfigDispatcher</a>インスタンスを生成し、 config_["/Manager/Assets"]を引数として<a class="el" href="a198003.html#section_simulation_config_dispatcher_dispatch">ConfigDispatcher::run</a> を呼び出す。</p>
<p>その結果は、エピソード開始時に登場する全 <a class="el" href="a193313.html" title="Asset のうち物理的実体を持つものを表すクラス">PhysicalAsset</a> のfull name、モデル名、instanceConfig及び対応する <a class="el" href="a192877.html" title="Asset のうち、行動判断を行う主体としてシミュレータ外部とObservation,Actionを入出力するものを表すクラス">Agent</a> を表す 以下のような階層構造を持ったobject(dict)となっていなければならない。 </p><div class="fragment"><div class="line">{</div>
<div class="line">    <span class="stringliteral">&quot;Blue&quot;</span>: { # 再外層は 陣営名として扱われる</div>
<div class="line">        <span class="stringliteral">&quot;Group1&quot;</span>: { #中間層はグループ名として扱われる</div>
<div class="line">            <span class="stringliteral">&quot;Asset1&quot;</span>:{ # 末端は<span class="stringliteral">&quot;type&quot;</span>==<span class="stringliteral">&quot;PhysicalAsset&quot;</span>となる。この場合のfull nameは<span class="stringliteral">&quot;Blue/Group1/Asset1&quot;</span>として生成される。</div>
<div class="line">                <span class="stringliteral">&quot;type&quot;</span>:<span class="stringliteral">&quot;PhysicalAsset&quot;</span>,</div>
<div class="line">                <span class="stringliteral">&quot;model&quot;</span>: <span class="stringliteral">&quot;ModelA&quot;</span>, # モデル名を指定する</div>
<div class="line">                <span class="stringliteral">&quot;instanceConfig&quot;</span>:{ # instanceConfigがあれば指定する</div>
<div class="line">                    ...</div>
<div class="line">                },</div>
<div class="line">                <span class="stringliteral">&quot;Agent&quot;</span>: Any # この PhysiacalAsset に紐付けられる Agent の</div>
<div class="line"><span class="preprocessor">                             # 生成用config(後述)を表すdict。</span></div>
<div class="line"><span class="preprocessor">                             # あるいは Agent用ConfigDispatcherによって</span></div>
<div class="line"><span class="preprocessor">                             # 同等の内容に展開可能な任意のjsonを与えてもよい。</span></div>
<div class="line">            },</div>
<div class="line">            ...</div>
<div class="line">        }</div>
<div class="line">    },</div>
<div class="line">    <span class="stringliteral">&quot;Red&quot;</span>:{  # 再外層は 陣営名として扱われる</div>
<div class="line">        ...</div>
<div class="line">    }</div>
<div class="line">}</div>
</div><!-- fragment --><p> この展開結果に従って <a class="el" href="a193313.html" title="Asset のうち物理的実体を持つものを表すクラス">PhysicalAsset</a> インスタンスの生成が行われる。</p>
<p>なお、 <a class="el" href="a192941.html" title="シミュレーション登場物の生成処理をjsonで記述しやすくするための機能を提供するクラス">ConfigDispatcher</a> を用いずに上記の構造を直接記述しても支障はない。</p>
<h2 class="doxsection"><a class="anchor" id="section_simulation_execution_agent_config_dispatch"></a>
Agent の生成について</h2>
<p>エピソード初期化時の <a class="el" href="a192877.html" title="Asset のうち、行動判断を行う主体としてシミュレータ外部とObservation,Actionを入出力するものを表すクラス">Agent</a> 生成は、 <a class="el" href="a198003.html">ConfigDispatcherによる再帰的な変換</a> 機能を用いて実現している。</p>
<p>config_["/Manager/AgentConfigDispatcher"]をaliasesとして <a class="el" href="a198003.html">ConfigDispatcher</a>インスタンスを生成しておく。</p>
<p><a class="el" href="a193313.html" title="Asset のうち物理的実体を持つものを表すクラス">PhysicalAsset</a> の生成時に用いた展開結果において、各 <a class="el" href="a193313.html" title="Asset のうち物理的実体を持つものを表すクラス">PhysicalAsset</a> が"Agent"キーを持っていた場合、 それを引数として<a class="el" href="a198003.html#section_simulation_config_dispatcher_dispatch">ConfigDispatcher::run</a> を呼び出す。</p>
<p>その結果は、 </p><div class="fragment"><div class="line">{</div>
<div class="line">    <span class="stringliteral">&quot;name&quot;</span>:str, # Agent の名前</div>
<div class="line">    <span class="stringliteral">&quot;port&quot;</span>:str, # Agent のポート名</div>
<div class="line">    <span class="stringliteral">&quot;type&quot;</span>:str, # Agent の種類</div>
<div class="line">    ... # その他種類に応じた要素</div>
<div class="line">}</div>
</div><!-- fragment --><p> となっている必要がある。</p>
<p>Agentの種類と、追加で指定が必要な要素は以下のとおり。</p><ul>
<li><p class="startli">Internal</p>
<p class="startli">Observation と Action が不要な、Agent クラス単体で行動判断が完結する <a class="el" href="a192877.html" title="Asset のうち、行動判断を行う主体としてシミュレータ外部とObservation,Actionを入出力するものを表すクラス">Agent</a> を指し、 ポリシー名が自動的に"Internal"となる。step 関数に与える Action には、 このような <a class="el" href="a192877.html" title="Asset のうち、行動判断を行う主体としてシミュレータ外部とObservation,Actionを入出力するものを表すクラス">Agent</a> に対応する Action を含めなくてもよい(省略しても任意の値を与えてもよい)。</p>
<p class="startli">追加要素は以下のとおり。</p><ul>
<li><p class="startli">model</p>
<p class="startli"><a class="el" href="a193125.html" title="Entityの生成を行うクラス。">Factory</a> におけるモデル名を表す文字列。省略不可。</p>
</li>
</ul>
</li>
<li><p class="startli">External</p>
<p class="startli">Observation と Action の入出力が必要な <a class="el" href="a192877.html" title="Asset のうち、行動判断を行う主体としてシミュレータ外部とObservation,Actionを入出力するものを表すクラス">Agent</a> クラス。</p>
<p class="startli">追加要素は以下のとおり。</p><ul>
<li><p class="startli">model</p>
<p class="startli"><a class="el" href="a193125.html" title="Entityの生成を行うクラス。">Factory</a> におけるモデル名を表す文字列。省略不可。</p>
</li>
<li><p class="startli">policy</p>
<p class="startli">ポリシー名を表す文字列。省略不可。</p>
</li>
</ul>
</li>
<li><p class="startli">ExpertE</p>
<p class="startli">模倣学習を行うための <a class="el" href="a198021.html#section_training_imitation_ExpertWrapper">ExpertWrapper</a> のうち、 親 <a class="el" href="a192909.html" title="シミュレーションで模擬される対象物を表すクラス">Asset</a> への command と環境外部へのobservation として expert の出力を用いるもの。</p>
<p class="startli">追加要素は以下のとおり。</p><ul>
<li><p class="startli">imitatorModel</p>
<p class="startli">模倣する側のFactory におけるモデル名を表す文字列。省略不可。</p>
</li>
<li><p class="startli">expertModel</p>
<p class="startli">模倣される側のFactory におけるモデル名を表す文字列。省略不可。</p>
</li>
<li><p class="startli">expertPolicy</p>
<p class="startli">模倣される側のポリシー名を表す文字列。省略時は"Internal"となる。</p>
</li>
<li><p class="startli">identifier</p>
<p class="startli">模倣用の軌跡データを出力する際の識別名。省略時は imitatorModelName と同一となる。</p>
</li>
</ul>
</li>
<li><p class="startli">ExpertI</p>
<p class="startli">模倣学習を行うための <a class="el" href="a198021.html#section_training_imitation_ExpertWrapper">ExpertWrapper</a> のうち、 親 <a class="el" href="a192909.html" title="シミュレーションで模擬される対象物を表すクラス">Asset</a> への command と環境外部へのobservation として imitator の出力を用いるもの。</p>
<p class="startli">追加要素は ExpertE と同じ。</p>
</li>
<li><p class="startli">ExpertBE</p>
<p class="startli">模倣学習を行うための <a class="el" href="a198021.html#section_training_imitation_ExpertWrapper">ExpertWrapper</a> のうち、 親 <a class="el" href="a192909.html" title="シミュレーションで模擬される対象物を表すクラス">Asset</a> への command として expert の出力を用い、 環境外部への observation として両方の出力を用いるもの。</p>
<p class="startli">追加要素は ExpertE と同じ。</p>
</li>
<li><p class="startli">ExpertBI</p>
<p class="startli">模倣学習を行うための <a class="el" href="a198021.html#section_training_imitation_ExpertWrapper">ExpertWrapper</a> のうち、 親 <a class="el" href="a192909.html" title="シミュレーションで模擬される対象物を表すクラス">Asset</a> への command として imitator の出力を用い、 環境外部への observation として両方の出力を用いるもの。</p>
<p class="startli">追加要素は ExpertE と同じ。</p>
</li>
</ul>
<h1 class="doxsection"><a class="anchor" id="section_simulation_execution_as_gymnasium_env"></a>
gymnasium インターフェース</h1>
<p>本シミュレータを利用する際は、 <a class="el" href="a193525.html" title="gymnasium(OpenAI gym)のEnvとしてのインターフェースを持ったシミュレーション実行管理クラスの具象クラス。">SimulationManager</a> クラスのインスタンスを直接生成するよりも、 gymnasium.Env を継承したマルチエージェント環境として実装されたラッパークラスである <a class="el" href="a191713.html" title="Copyright (c) 2021-2025 Air Systems Research Center, Acquisition, Technology &amp; Logistics Agency(ATLA)">ASRCAISim1.GymManager</a> クラスを使用することを推奨する。</p>
<h2 class="doxsection"><a class="anchor" id="section_simulation_execution_GymManager"></a>
GymManager クラス</h2>
<h3 class="doxsection"><a class="anchor" id="section_simulation_execution_GymManager_init"></a>
コンストラクタ(<b>init</b>)</h3>
<p>コンストラクタ引数は、以下のようなcontextを表すdictとする。</p>
<div class="fragment"><div class="line">context={</div>
<div class="line">    <span class="stringliteral">&quot;config&quot;</span>:Union[Dict[str,Any]|List[Union[Dict[str,Any]|str]]], <span class="comment"># SimulationManager のコンストラクタに与えるconfigを指定する。</span></div>
<div class="line"> </div>
<div class="line">    <span class="stringliteral">&quot;worker_index&quot;</span>:int, <span class="comment"># worker indexを指定する。省略時は0。</span></div>
<div class="line">                        <span class="comment">#プロセス中の全シミュレーションインスタンスに影響する。</span></div>
<div class="line"> </div>
<div class="line">    <span class="stringliteral">&quot;vector_index&quot;</span>:int, <span class="comment"># vector indexを指定する。省略時は0。</span></div>
<div class="line">    </div>
<div class="line">    <span class="stringliteral">&quot;overrider&quot;</span>:Optional[Callable[[Dict[str,Any],int,int],Dict[str,Any]]], <span class="comment"># worker_index及びvector_indexに応じたconfig置換関数を用いる場合はここで与える。</span></div>
<div class="line">                                                                           <span class="comment"># std::function&lt;nl::json(const nl::json&amp;,const std::int32_t&amp;,const std::int32_t&amp;)&gt;相当。</span></div>
<div class="line"> </div>
<div class="line">    <span class="stringliteral">&quot;manager_class&quot;</span>:Optional[Type], <span class="comment"># SimulationManager 以外のクラスを使用したい場合はそのクラスオブジェクトを与える。</span></div>
<div class="line">}</div>
</div><!-- fragment --><h3 class="doxsection"><a class="anchor" id="section_simulation_execution_GymManager_reconfigure"></a>
コンフィグの書き換え</h3>
<p>本シミュレータは、同一の <a class="el" href="a193525.html" title="gymnasium(OpenAI gym)のEnvとしてのインターフェースを持ったシミュレーション実行管理クラスの具象クラス。">SimulationManager</a> インスタンスを複数エピソードにわたって 繰り返し使い続けるものとしているが、複数のエピソードを並列に実行したい場合や、 一定エピソードごとに登場物やルール、報酬等を変更したい場合も想定される。</p>
<p>そのような場合に <a class="el" href="a193525.html" title="gymnasium(OpenAI gym)のEnvとしてのインターフェースを持ったシミュレーション実行管理クラスの具象クラス。">SimulationManager</a> インスタンスを再生成することなく対応するために、 <a class="el" href="a193525.html" title="gymnasium(OpenAI gym)のEnvとしてのインターフェースを持ったシミュレーション実行管理クラスの具象クラス。">SimulationManager</a> インスタンス生成時と各エピソード開始時にコンフィグを書き換える機能を有している。</p>
<p>書き換え対象は <a class="el" href="a193525.html" title="gymnasium(OpenAI gym)のEnvとしてのインターフェースを持ったシミュレーション実行管理クラスの具象クラス。">SimulationManager</a> のコンストラクタ引数 config として与えられるもの、 すなわち、 <a class="el" href="a193525.html" title="gymnasium(OpenAI gym)のEnvとしてのインターフェースを持ったシミュレーション実行管理クラスの具象クラス。">SimulationManager</a> 自身のコンフィグ(Managerコンフィグ)と、 <a class="el" href="a193125.html" title="Entityの生成を行うクラス。">Factory</a> に登録しているモデルのコンフィグ(Factoryコンフィグ)の2種類であり、 クラスの置換には対応していない。</p>
<h4 class="doxsection"><a class="anchor" id="section_simulation_execution_GymManager_reconfigure_at_instantiation"></a>
インスタンス生成時の書き換え</h4>
<p><a class="el" href="a193525.html" title="gymnasium(OpenAI gym)のEnvとしてのインターフェースを持ったシミュレーション実行管理クラスの具象クラス。">SimulationManager</a> のコンストラクタに与える config を複数使い分けることでも インスタンスごとに異なる環境として生成することが可能であるが、 強化学習ライブラリの仕様によってはコンストラクタ引数を変えることが困難であることも想定される。</p>
<p>そのため、 <a class="el" href="a193525.html" title="gymnasium(OpenAI gym)のEnvとしてのインターフェースを持ったシミュレーション実行管理クラスの具象クラス。">SimulationManager</a> のコンストラクタ引数として、 config を書き換えるための 関数オブジェクトとして overrider を与えることによって、 コンストラクタ内部で config を書き換える処理を行うことを可能としている。</p>
<p>overrider が取る引数は full config, worker index, vector indexの3つとし、書き換え後のfull configを返すものとする。</p>
<h4 class="doxsection"><a class="anchor" id="section_simulation_execution_GymManager_reconfigure_on_episode_begin"></a>
エピソード開始時の書き換え</h4>
<p>エピソード開始時の書き換えは、reset 関数の呼び出し前までに、 <a class="el" href="a193525.html" title="gymnasium(OpenAI gym)のEnvとしてのインターフェースを持ったシミュレーション実行管理クラスの具象クラス。">SimulationManager</a> の <a class="el" href="a193525.html#a86a5f6ac42066bdcf5d200e6117b0055">requestReconfigure</a> 関数に Manager と <a class="el" href="a193125.html" title="Entityの生成を行うクラス。">Factory</a> 登録モデルそれぞれの置換用 json を与えることで、 次の reset 関数の先頭で書き換えが実行される。</p>
<p>置換用 json は、元の json に対して適用すべき merge_patch として与えるものとする。 使用方法としては、対戦ごとに各陣営の <a class="el" href="a192877.html" title="Asset のうち、行動判断を行う主体としてシミュレータ外部とObservation,Actionを入出力するものを表すクラス">Agent</a> を変更したり、 学習の進捗に応じてルールや報酬を変更したりするような場合を想定しており、 環境の外部から呼び出すことも、Callback クラスによって内部から呼び出すことも可能である。</p>
<p>なお、ラッパークラスである <a class="el" href="a194261.html">GymManager</a> クラスからも <a class="el" href="a194261.html#ae39e7a4e596cc5b041ff455222070ee1">requestReconfigure</a>関数の呼び出しが可能である。</p>
<h2 class="doxsection"><a class="anchor" id="section_simulation_execution_SinglizedEnv"></a>
SinglizedEnv クラス</h2>
<p><a class="el" href="a194265.html">SinglizedEnv</a> クラスは <a class="el" href="a194261.html">GymManager</a> の派生クラスであり、 登場する <a class="el" href="a192877.html" title="Asset のうち、行動判断を行う主体としてシミュレータ外部とObservation,Actionを入出力するものを表すクラス">Agent</a> のうち指定した一つのみの Observation, Action を入出力し、 それ以外の <a class="el" href="a192877.html" title="Asset のうち、行動判断を行う主体としてシミュレータ外部とObservation,Actionを入出力するものを表すクラス">Agent</a> の行動を環境内部で計算することによってシングルエージェント環境としたものである。</p>
<p>マルチエージェント環境に対応していない強化学習ライブラリを使用したり、 模倣学習時に学習対象の <a class="el" href="a192877.html" title="Asset のうち、行動判断を行う主体としてシミュレータ外部とObservation,Actionを入出力するものを表すクラス">Agent</a> を限定するために使用したりすることを想定している。</p>
<p>入出力の対象とならなかった <a class="el" href="a192877.html" title="Asset のうち、行動判断を行う主体としてシミュレータ外部とObservation,Actionを入出力するものを表すクラス">Agent</a> については、コンストラクタにおいて <a class="el" href="#section_simulation_execution_StandalonePolicy">StandalonePolicy</a>オブジェクトを渡すことで、 環境の内部で Action の計算を行う。</p>
<p>また、入出力対象とする <a class="el" href="a192877.html" title="Asset のうち、行動判断を行う主体としてシミュレータ外部とObservation,Actionを入出力するものを表すクラス">Agent</a> はその fullName によって判定するものとし、 コンストラクタに与えた判定用の関数で最初に True となった <a class="el" href="a192877.html" title="Asset のうち、行動判断を行う主体としてシミュレータ外部とObservation,Actionを入出力するものを表すクラス">Agent</a> を対象とする。 コンストラクタ引数 context には <a class="el" href="a194261.html">GymManager</a> が必要とするものに加え以下の値を追加したものである。</p>
<div class="fragment"><div class="line">context.update({</div>
<div class="line">    <span class="stringliteral">&quot;target&quot;</span>:Union[Callable[[str],bool],str], <span class="comment"># observation,actionの入出力対象のAgentを特定するための関数。</span></div>
<div class="line">                                              <span class="comment"># AgentのfullNameを引数にとってboolを返す関数を与える。</span></div>
<div class="line">                                              <span class="comment"># 最初にTrueとなったAgentを対象とみなす。</span></div>
<div class="line">                                              <span class="comment"># Callableの代わりに文字列を指定した場合、</span></div>
<div class="line">                                              <span class="comment"># その文字列で始まるかどうか(startswith)を判定条件にすることが可能。</span></div>
<div class="line"> </div>
<div class="line">    <span class="stringliteral">&quot;policies&quot;</span>: Dict[str,StandalonePolicy], <span class="comment"># 内部でactionを計算するためのStandalonePolicyオブジェクトのdict。</span></div>
<div class="line">                                            <span class="comment"># キーはポリシー名とする。</span></div>
<div class="line"> </div>
<div class="line">    <span class="stringliteral">&quot;policyMapper&quot;</span>: Optional[Callable[[str],str]], <span class="comment"># AgentのfullNameから使用するpolicyの名称を計算する。</span></div>
<div class="line">                                                   <span class="comment"># 省略した場合はデフォルトの命名規則に従い、full nameの末尾にあるポリシー名が使われる。</span></div>
<div class="line">    </div>
<div class="line">   <span class="stringliteral">&quot;runUntilAllDone&quot;</span>: bool, <span class="comment"># 対象AgentのdoneがTrueとなっても、done[&quot;__all__&quot;]がTrueとなるまで内部で</span></div>
<div class="line">                            <span class="comment"># エピソードの計算を継続するか否か。デフォルトはTrue。</span></div>
<div class="line">})</div>
</div><!-- fragment --><h1 class="doxsection"><a class="anchor" id="section_simulation_execution_SimpleEvaluator"></a>
SimpleEvaluator</h1>
<p>最小限の評価用環境として、全 <a class="el" href="a192877.html" title="Asset のうち、行動判断を行う主体としてシミュレータ外部とObservation,Actionを入出力するものを表すクラス">Agent</a> の行動判断を StandalonePolicy によって内部で処理し、 GymManager を用いたエピソードの実行を自動で行う SimpleEvaluator クラスを実装している。</p>
<h1 class="doxsection"><a class="anchor" id="section_simulation_execution_StandalonePolicy"></a>
StandalonePolicy</h1>
<p>通常、gymnasium 環境においてエピソードの実行は外部から制御されるため、 ポリシーが Action を計算する処理の実装方法は制約が無い。 しかし、例えば異なる手法で学習された複数の行動判断モデルどうしを戦わせて評価したい場合や、 一部の <a class="el" href="a192877.html" title="Asset のうち、行動判断を行う主体としてシミュレータ外部とObservation,Actionを入出力するものを表すクラス">Agent</a> について環境の内部で処理を済ませたい場合を想定して、 本シミュレータでは <a class="el" href="a194293.html">StandalonePolicy</a> クラスとしてポリシーの推論のための共通インターフェースを定義している。</p>
<p><a class="el" href="a194293.html">StandalonePolicy</a> クラスは 引数、返り値なしの <a class="el" href="a194293.html#a330009391142775cfff69296b3070848">reset</a> 関数と、 Observation 等を入力して Action を出力する <a class="el" href="a194293.html#a24a41f1aa151311a11231a67b7197eea">step</a> 関数の二つを有するものとし、 それぞれ環境側の reset,step と対になるものである。step 関数の引数として与えられる変数は以下の通りである。</p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">名称  </th><th class="markdownTableHeadNone">概要  </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">observation  </td><td class="markdownTableBodyNone">Environmentから得られたobservation。  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">reward  </td><td class="markdownTableBodyNone">Environmentから得られたreward。  </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">done  </td><td class="markdownTableBodyNone">Environmentから得られたdone。  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">info  </td><td class="markdownTableBodyNone">Environmentから得られたinfo。  </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">agentFullName  </td><td class="markdownTableBodyNone">計算対象のAgentの完全な名称であり、agentName:modelName:policyNameの形をとる。  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">observation_space  </td><td class="markdownTableBodyNone">与えられたObservationのSpace。  </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">action_space  </td><td class="markdownTableBodyNone">計算すべきActionのSpace。  </td></tr>
</table>
<h2 class="doxsection"><a class="anchor" id="section_simulation_execution_Agent_naming_convention"></a>
Agentのfull nameの書式</h2>
<p>本シミュレータにおける <a class="el" href="a192877.html" title="Asset のうち、行動判断を行う主体としてシミュレータ外部とObservation,Actionを入出力するものを表すクラス">Agent</a> のfull nameの命名規則は、 インスタンス名、モデル名、ポリシー名を":"で繋いだものとする。 例えばインスタンス名が"Agent1"、モデル名が"AgentModel1"、ポリシー名が"Policy1"である場合、 Agentのfull nameは"Agent1:AgentModel1:Policy1"となる。</p>
<p>また、ポリシー名について"Internal"は予約語としており、Action の計算が不要で本シミュレータの 内部で動作が完結するタイプの <a class="el" href="a192877.html" title="Asset のうち、行動判断を行う主体としてシミュレータ外部とObservation,Actionを入出力するものを表すクラス">Agent</a> を示すものとして扱っている。 </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<div id="page-nav" class="page-nav-panel">
<div id="page-nav-resize-handle"></div>
<div id="page-nav-tree">
<div id="page-nav-contents">
</div><!-- page-nav-contents -->
</div><!-- page-nav-tree -->
</div><!-- page-nav -->
</div><!-- container -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.14.0 </li>
  </ul>
</div>
</body>
</html>
