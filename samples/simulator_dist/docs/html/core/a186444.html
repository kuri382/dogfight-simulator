<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="ja">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.14.0"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>ASRCAISim1: ConfigDispatcher によるjson object の再帰的な変換</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="clipboard.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript" src="cookie.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(function() { init_search(); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="asrc_doc_stylesheet.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">ASRCAISim1
   </div>
  </td>
    <td>        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <span id="MSearchSelect" class="search-icon" onmouseover="return searchBox.OnSearchSelectShow()" onmouseout="return searchBox.OnSearchSelectHide()"><span class="search-icon-dropdown"></span></span>
          <input type="text" id="MSearchField" value="" placeholder="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><div id="MSearchCloseImg" class="close-icon"></div></a>
          </span>
        </div>
</td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.14.0 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search/",'.html');
</script>
<script type="text/javascript">
$(function() { codefold.init(); });
</script>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(function(){initNavTree('a186444.html','',''); });
</script>
<div id="container">
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">ConfigDispatcher によるjson object の再帰的な変換 </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>本シミュレータは、config として与えた json から確率による選択や並び替え、要素の複製や別名参照による置換等を経て、 複雑な登場物の生成を記述しやすくするための <a class="el" href="a182012.html" title="シミュレーション登場物の生成処理をjsonで記述しやすくするための機能を提供するクラス">ConfigDispatcher</a> クラスを実装している。</p>
<p><a class="el" href="a182012.html" title="シミュレーション登場物の生成処理をjsonで記述しやすくするための機能を提供するクラス">ConfigDispatcher</a> クラスそのものの機能は json を与えると一定の規則に従って再帰的に変換を行い、 一つの json を生成するというものである。</p>
<p><a class="el" href="a182012.html" title="シミュレーション登場物の生成処理をjsonで記述しやすくするための機能を提供するクラス">ConfigDispatcher</a> の変換対象物及び生成物となる json の記述方法は以下の通りであり、 初期化の際は alias として登録したい変換対象物又は生成物を列挙した object を与える。 変換の実行は <a class="el" href="a182012.html" title="シミュレーション登場物の生成処理をjsonで記述しやすくするための機能を提供するクラス">ConfigDispatcher</a> のメンバ変数 <a class="el" href="a182012.html#ab13d0d4cdbe6e3dc131d6ae4f2dfe0b9">run</a> に生成元 json を引数として与えることで行う。</p>
<h1 class="doxsection"><a class="anchor" id="section_simulation_config_dispatcher_usage"></a>
ConfigDispatcherの使用方法</h1>
<p><a class="el" href="a182012.html" title="シミュレーション登場物の生成処理をjsonで記述しやすくするための機能を提供するクラス">ConfigDispatcher</a> のコンストラクタにはjson objectを与える。 この引数の各要素は、メンバ変数aliasesに格納され、展開時に"alias"として参照される。</p>
<p>値を生成する際には <a class="el" href="a182012.html#ab13d0d4cdbe6e3dc131d6ae4f2dfe0b9">ConfigDispatcher::run</a> に json を引数として呼び出すと、後述の仕様に従って展開された結果が得られる。</p>
<h1 class="doxsection"><a class="anchor" id="section_simulation_config_dispatcher_dispatch"></a>
再帰的な展開の仕様</h1>
<p>元となるjsonを j として、以下のように展開される。</p>
<ol type="1">
<li>基本展開<ul>
<li><p class="startli">j["type"]=="direct"の場合</p>
<p class="startli">j["value"]を生成物として返す。</p>
<p class="startli">例えば、 </p><div class="fragment"><div class="line">{</div>
<div class="line">    <span class="stringliteral">&quot;type&quot;</span>: <span class="stringliteral">&quot;direct&quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;value&quot;</span>: [1,2,3]            </div>
<div class="line">}</div>
</div><!-- fragment --><p> は </p><div class="fragment"><div class="line">[1,2,3]</div>
</div><!-- fragment --><p> となる。</p>
</li>
<li><p class="startli">j["type"]=="alias"の場合</p>
<p class="startli">j["alias"]に記述された文字列をキーとして、 自身の属する <a class="el" href="a182012.html" title="シミュレーション登場物の生成処理をjsonで記述しやすくするための機能を提供するクラス">ConfigDispatcher</a> インスタンスのメンバ変数<a class="el" href="a182012.html#a9006022ff8068351408a82fc56b895f3">aliases</a> に登録されているjsonを検索し、その値をコピーして再帰的に展開した結果を生成物として返す。</p>
<p class="startli">例えば、aliasesに"foo"という名前で <span class="tt">
        {
            "type": "direct",
            "value": [1,2,3]            \ilinebr&lt;br&gt;
        }
        </span> が登録されていた場合、 <span class="tt">
        {
            "type": "alias",
            "alias": "foo"
        }
        </span> は再帰的に展開されて <span class="tt">
        [1,2,3]
        </span> となる。</p>
</li>
<li><p class="startli">j["type"]=="choice"の場合</p>
<p class="startli">j["weights"]で与えられた重みに従い、 j["candidates"]で与えられた要素から一つ選択して再帰的に展開し、その生成結果を生成物として返す。</p>
<p class="startli">例えば、 <span class="tt">
        {
            "type": "choice",
            "weights": [0.2,0.3,0.5],
            "candidates": [
                {
                    "type": "direct",
                    "value": 1
                },
                {
                    "type": "direct",
                    "value": true
                },
                {
                    "type": "direct",
                    "value": "abc"
                },
            ]
        }
        </span> は20の確率で1、30の確率でtrue、50の確率で"abc"となる。</p>
</li>
<li>j["type"]=="group"の場合<ul>
<li><p class="startli">j["elements"]が与えられた場合 j["elements"]で与えられた要素を、 j["order"]=="fixed"のときはそのままの順序で、j["order"]=="shuffled"のときはランダムに並び替えて、 j["names"]で与えられたキーに対応付けたobjectとして生成する。</p>
<p class="startli">"order"を省略した場合は"fixed"とみなし、 "names"を省略した場合は、先頭から順に"Element1", "Element2",...のように命名される。</p>
<p class="startli">例えば、 <span class="tt">
            {
                "type": "group",
                "order": "fixed",
                "names": ["foo","bar"],
                "elements":[
                    {
                        "type": "direct",
                        "value": 123
                    },
                    {
                        "type": "direct",
                        "value": "abc"
                    }
                ]
            }
            </span> は <span class="tt">
            {
                "foo": 123,
                "bar": "abc"
            }
            </span> となる。</p>
</li>
<li><p class="startli">j["elements"]が与えられなかった場合 "elements"と"names"を与える代わりの書き方として、 jの要素としてnameとelementの組を列挙してもよい。 "type"以外のjの全要素を"names"と"elements"に自動的に追加して展開を行う。</p>
<p class="startli">例えば、 <span class="tt">
            {
                "type": "group",
                "A": {
                    "type": "direct",
                    "value": 123
                },
                "B": {
                    "type": "direct",
                    "value": true
                }
            }
            </span> は <span class="tt">
            {
                "type": "group",
                "names": ["A","B"],
                "elements": [
                    {
                        "type": "direct",
                        "value": 123
                    },
                    {
                        "type": "direct",
                        "value": true
                    }
                ]
            }
            </span> と等価なものと解釈される。</p>
</li>
</ul>
</li>
<li><p class="startli">j["type"]=="concatenate"の場合</p>
<p class="startli">j["elements"]で与えられた各要素について再帰的に展開し、 その生成結果を結合して一つのj["type"]=="group"相当のobjectを生成する。</p>
<p class="startli">このとき、j["elements"]の各要素を展開した結果をsubとして、 subの"type"によって結合方法が以下のように変わる。</p><ul>
<li>"group"の場合 subの各要素(キーと値の組)をそのまま結合結果に加える。</li>
<li>それ以外の場合 これまでに結合された要素数をNとして、 キーを"Element"+str(N+1)、値をsubとして結合結果に加える。</li>
</ul>
<p class="startli">例えば、 <span class="tt">
        {
            "type": "concatenate",
            "elements": [
                {
                    "type": "group",
                    "order": "fixed",
                    "names": ["foo","bar"],
                    "elements":[
                        {
                            "type": "direct",
                            "value": 123
                        },
                        {
                            "type": "direct",
                            "value": "abc"
                        }
                    ]
                },
                {
                    "type": "direct",
                    "value": true
                }
            ]
        }
        </span> は <span class="tt">
        {
            "foo": 123,
            "bar": "abc",
            "Element3": true
        }
        </span> となる。</p>
</li>
<li><p class="startli">j["type"]=="broadcast"の場合</p>
<p class="startli">j["element"]で与えられたarrayの要素をj["number"]個複製し、 j["names"]にstrのarrayとして与えられた名称と対応付けて、 j["type"]=="group"相当のobject(dict)を生成する。</p>
<p class="startli">"names"を省略した場合は、先頭から順に"Element1", "Element2",...のように命名される。</p>
<p class="startli">また、j["dispatchAfterBroadcast"]がtrueのときは複製してから各要素を展開し、 falseのときは先に展開してから複製を行う。省略時はfalseとみなす。</p>
<p class="startli">例えば、 <span class="tt">
        {
            "type": "broadcast",
            "number": 3,
            "names":["A","B","C"],
            "element": {
                "type": "choice",
                "weights": [0.2,0.3,0.5],
                "candidates": [
                    {
                        "type": "direct",
                        "value": 1
                    },
                    {
                        "type": "direct",
                        "value": true
                    },
                    {
                        "type": "direct",
                        "value": "abc"
                    },
                ]
            }
            "dispatchAfterBroadcast": true
        }
        </span> は"element"を先に展開してから複製するため、 <span class="tt">
        {"A":1,"B":1,"C":1}             # 20%
        {"A":true,"B":true,"C":true}    # 30%
        {"A":"abc","B":"abc","C":"abc"} # 50%
        </span> となる。</p>
</li>
<li><p class="startli">j["type"]=="none"の場合</p>
<p class="startli">空っぽの要素を表す。最終生成物からは削除されるが、 例えば"choice"において「何も選ばない」ということを表現するために用いる。</p>
</li>
<li><p class="startli">j["type"]が上記のいずれでもない場合</p>
<p class="startli">jそのものを生成物として返す。</p>
</li>
<li><p class="startli">jが"type"キーを持たない、又はobject(dict)ではない場合</p>
<p class="startli">jそのものを生成物として返す。</p>
</li>
</ul>
</li>
<li><p class="startli">instance の指定による展開済要素の取得</p>
<p class="startli">jが"instance"キーを持っていた場合、 今までに j["instance"] 一致する名前を持つ生成物が生成されていた場合、 新たな基本展開は行わず、既存の生成物を返す。</p>
<p class="startli">未生成だった場合は、通常の基本展開を行った結果を返す。</p>
</li>
<li><p class="startli">index の指定による要素抽出</p>
<p class="startli">jが"index"キーを持っていた場合、 jの基本展開を行った結果が"type"=="group"であれば、 j["index"]番目の値のみを返す。 "type"!="group"ならば無視される。</p>
</li>
<li><p class="startli">overrider の指定による生成結果の上書き</p>
<p class="startli">jが"overrider"キーを持っていた場合、 jの基本展開結果をbase、j["overrider"]の展開結果をpatchとして、 baseに対してpatchをmerge_patch処理によって上書きする。 </p>
</li>
</ol>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<div id="page-nav" class="page-nav-panel">
<div id="page-nav-resize-handle"></div>
<div id="page-nav-tree">
<div id="page-nav-contents">
</div><!-- page-nav-contents -->
</div><!-- page-nav-tree -->
</div><!-- page-nav -->
</div><!-- container -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.14.0 </li>
  </ul>
</div>
</body>
</html>
