<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="ja">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.14.0"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Supervised: core_plugins/Supervised/Supervised/AuxiliaryTaskUtilForHandyRL.py Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="clipboard.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript" src="cookie.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(function() { init_search(); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="asrc_doc_stylesheet.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">Supervised
   </div>
  </td>
    <td>        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <span id="MSearchSelect" class="search-icon" onmouseover="return searchBox.OnSearchSelectShow()" onmouseout="return searchBox.OnSearchSelectHide()"><span class="search-icon-dropdown"></span></span>
          <input type="text" id="MSearchField" value="" placeholder="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><div id="MSearchCloseImg" class="close-icon"></div></a>
          </span>
        </div>
</td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.14.0 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search/",'.html');
</script>
<script type="text/javascript">
$(function() { codefold.init(); });
</script>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(function(){initNavTree('a51689_source.html','',''); });
</script>
<div id="container">
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div class="header">
  <div class="headertitle"><div class="title">AuxiliaryTaskUtilForHandyRL.py</div></div>
</div><!--header-->
<div class="contents">
<a href="a51689.html">Go to the documentation of this file.</a><div class="fragment"><div class="line"><a id="l00001" name="l00001"></a><span class="lineno"><a class="line" href="a197806.html">    1</a></span><span class="comment"># Copyright (c) 2021-2025 Air Systems Research Center, Acquisition, Technology &amp; Logistics Agency(ATLA)</span></div>
<div class="line"><a id="l00002" name="l00002"></a><span class="lineno">    2</span><span class="stringliteral">&quot;&quot;&quot;HandyRLで補助タスク(教師あり/教師なし学習)を行うための基底クラス群</span></div>
<div class="line"><a id="l00003" name="l00003"></a><span class="lineno">    3</span><span class="stringliteral">&quot;&quot;&quot;</span></div>
<div class="line"><a id="l00004" name="l00004"></a><span class="lineno">    4</span><span class="keyword">import</span> sys</div>
<div class="line"><a id="l00005" name="l00005"></a><span class="lineno">    5</span><span class="keyword">import</span> collections</div>
<div class="line"><a id="l00006" name="l00006"></a><span class="lineno">    6</span><span class="keyword">import</span> copy</div>
<div class="line"><a id="l00007" name="l00007"></a><span class="lineno">    7</span><span class="keyword">import</span> gymnasium <span class="keyword">as</span> gym</div>
<div class="line"><a id="l00008" name="l00008"></a><span class="lineno">    8</span><span class="keyword">import</span> random</div>
<div class="line"><a id="l00009" name="l00009"></a><span class="lineno">    9</span><span class="keyword">import</span> bz2</div>
<div class="line"><a id="l00010" name="l00010"></a><span class="lineno">   10</span><span class="keyword">import</span> cloudpickle</div>
<div class="line"><a id="l00011" name="l00011"></a><span class="lineno">   11</span><span class="keyword">import</span> numpy <span class="keyword">as</span> np</div>
<div class="line"><a id="l00012" name="l00012"></a><span class="lineno">   12</span><span class="keyword">import</span> torch</div>
<div class="line"><a id="l00013" name="l00013"></a><span class="lineno">   13</span><span class="keyword">import</span> torch.nn <span class="keyword">as</span> nn</div>
<div class="line"><a id="l00014" name="l00014"></a><span class="lineno">   14</span><span class="keyword">import</span> torch.optim <span class="keyword">as</span> optim</div>
<div class="line"><a id="l00015" name="l00015"></a><span class="lineno">   15</span> </div>
<div class="line"><a id="l00016" name="l00016"></a><span class="lineno">   16</span><span class="keyword">from</span> ASRCAISim1.plugins.HandyRLUtility.model <span class="keyword">import</span> ModelBase</div>
<div class="line"><a id="l00017" name="l00017"></a><span class="lineno">   17</span><span class="keyword">from</span> ASRCAISim1.plugins.HandyRLUtility.util <span class="keyword">import</span> map_r, bimap_r, trimap_r, rotate</div>
<div class="line"><a id="l00018" name="l00018"></a><span class="lineno">   18</span><span class="keyword">from</span> ASRCAISim1.plugins.HandyRLUtility.RecurrentBlock <span class="keyword">import</span> RecurrentBlock</div>
<div class="line"><a id="l00019" name="l00019"></a><span class="lineno">   19</span> </div>
<div class="foldopen" id="foldopen00020" data-start="" data-end="">
<div class="line"><a id="l00020" name="l00020"></a><span class="lineno"><a class="line" href="a197806.html#a5870da1c12de129b123fe850ed84358e">   20</a></span><span class="keyword">def </span><a class="code hl_function" href="a197806.html#a5870da1c12de129b123fe850ed84358e">to_torch</a>(x):</div>
<div class="line"><a id="l00021" name="l00021"></a><span class="lineno">   21</span>    <span class="keywordflow">return</span> map_r(x, <span class="keyword">lambda</span> x: torch.from_numpy(np.array(x)).contiguous() <span class="keywordflow">if</span> x <span class="keywordflow">is</span> <span class="keywordflow">not</span> <span class="keywordtype">None</span> <span class="keywordflow">else</span> <span class="keywordtype">None</span>)</div>
<div class="line"><a id="l00022" name="l00022"></a><span class="lineno">   22</span> </div>
</div>
<div class="foldopen" id="foldopen00023" data-start="" data-end="">
<div class="line"><a id="l00023" name="l00023"></a><span class="lineno"><a class="line" href="a197806.html#a183fe507d175130f82439ff94500f9e5">   23</a></span><span class="keyword">def </span><a class="code hl_function" href="a197806.html#a183fe507d175130f82439ff94500f9e5">to_gpu</a>(data):</div>
<div class="line"><a id="l00024" name="l00024"></a><span class="lineno">   24</span>    <span class="keywordflow">return</span> map_r(data, <span class="keyword">lambda</span> x: x.cuda() <span class="keywordflow">if</span> x <span class="keywordflow">is</span> <span class="keywordflow">not</span> <span class="keywordtype">None</span> <span class="keywordflow">else</span> <span class="keywordtype">None</span>)</div>
<div class="line"><a id="l00025" name="l00025"></a><span class="lineno">   25</span> </div>
</div>
<div class="foldopen" id="foldopen00026" data-start="" data-end="">
<div class="line"><a id="l00026" name="l00026"></a><span class="lineno"><a class="line" href="a197806.html#a9730abcd04ed275abbd43267a5e9e887">   26</a></span><span class="keyword">def </span><a class="code hl_function" href="a197806.html#a9730abcd04ed275abbd43267a5e9e887">replace_none</a>(a, b):</div>
<div class="line"><a id="l00027" name="l00027"></a><span class="lineno">   27</span>    <span class="keywordflow">return</span> a <span class="keywordflow">if</span> a <span class="keywordflow">is</span> <span class="keywordflow">not</span> <span class="keywordtype">None</span> <span class="keywordflow">else</span> b</div>
<div class="line"><a id="l00028" name="l00028"></a><span class="lineno">   28</span> </div>
</div>
<div class="foldopen" id="foldopen00029" data-start="" data-end="">
<div class="line"><a id="l00029" name="l00029"></a><span class="lineno"><a class="line" href="a199780.html">   29</a></span><span class="keyword">class </span><a class="code hl_class" href="a199780.html">AuxiliaryTaskManager</a>:</div>
<div class="foldopen" id="foldopen00030" data-start="" data-end="">
<div class="line"><a id="l00030" name="l00030"></a><span class="lineno"><a class="line" href="a199780.html#a27673a4fff542d421cee67f769197d29">   30</a></span>    <span class="keyword">def </span><a class="code hl_function" href="a199780.html#a27673a4fff542d421cee67f769197d29">__init__</a>(self,args,model):</div>
<div class="line"><a id="l00031" name="l00031"></a><span class="lineno"><a class="line" href="a199780.html#a59231da590ccbb649314e4a7bb35da12">   31</a></span>        self.<a class="code hl_variable" href="a199780.html#a59231da590ccbb649314e4a7bb35da12">args</a>=args</div>
<div class="line"><a id="l00032" name="l00032"></a><span class="lineno"><a class="line" href="a199780.html#a55092b09b7f4711fd43833e9dbd8fcc0">   32</a></span>        self.<a class="code hl_variable" href="a199780.html#a55092b09b7f4711fd43833e9dbd8fcc0">model</a>=model</div>
<div class="line"><a id="l00033" name="l00033"></a><span class="lineno">   33</span>        networks = model.auxiliary_branches <span class="keywordflow">if</span> hasattr(model,<span class="stringliteral">&#39;auxiliary_branches&#39;</span>) <span class="keywordflow">else</span> {}</div>
<div class="line"><a id="l00034" name="l00034"></a><span class="lineno">   34</span>        hiddens = model.init_auxiliary_hidden()</div>
<div class="line"><a id="l00035" name="l00035"></a><span class="lineno">   35</span>        custom_classes=self.<a class="code hl_variable" href="a199780.html#a59231da590ccbb649314e4a7bb35da12">args</a>[<span class="stringliteral">&#39;custom_classes&#39;</span>]</div>
<div class="line"><a id="l00036" name="l00036"></a><span class="lineno"><a class="line" href="a199780.html#adf5db3bb5a72111421f305a8bce645e8">   36</a></span>        self.<a class="code hl_variable" href="a199780.html#adf5db3bb5a72111421f305a8bce645e8">tasks</a>={</div>
<div class="line"><a id="l00037" name="l00037"></a><span class="lineno">   37</span>            name: custom_classes.get(v.get(<span class="stringliteral">&#39;class&#39;</span>,<span class="stringliteral">&#39;&#39;</span>),AuxiliaryTaskBase)(name,v,networks[name],hiddens[name])</div>
<div class="line"><a id="l00038" name="l00038"></a><span class="lineno">   38</span>            <span class="keywordflow">for</span> name,v <span class="keywordflow">in</span> args[<span class="stringliteral">&#39;auxiliary_tasks&#39;</span>].items()</div>
<div class="line"><a id="l00039" name="l00039"></a><span class="lineno">   39</span>        }</div>
<div class="line"><a id="l00040" name="l00040"></a><span class="lineno"><a class="line" href="a199780.html#a3d67fe9f78b92dd308cd43f6b8588b2c">   40</a></span>        self.<a class="code hl_variable" href="a199780.html#a3d67fe9f78b92dd308cd43f6b8588b2c">policy_to_train</a> = args[<span class="stringliteral">&#39;policy_to_train&#39;</span>]</div>
<div class="line"><a id="l00041" name="l00041"></a><span class="lineno">   41</span>        <span class="comment">#bufferの設定</span></div>
<div class="line"><a id="l00042" name="l00042"></a><span class="lineno"><a class="line" href="a199780.html#a2af5a32a89659aa800f6570e5568488d">   42</a></span>        self.<a class="code hl_variable" href="a199780.html#a2af5a32a89659aa800f6570e5568488d">episodes</a>=[]</div>
<div class="line"><a id="l00043" name="l00043"></a><span class="lineno"><a class="line" href="a199780.html#a910e8a532380740b9062313fb70ba15c">   43</a></span>        self.<a class="code hl_variable" href="a199780.html#a910e8a532380740b9062313fb70ba15c">capacity</a>=1048576</div>
<div class="line"><a id="l00044" name="l00044"></a><span class="lineno"><a class="line" href="a199780.html#aaa902cc6cff5982fd00c82282f50ad0f">   44</a></span>        self.<a class="code hl_variable" href="a199780.html#aaa902cc6cff5982fd00c82282f50ad0f">_ep_idx_ofs</a> = 0</div>
<div class="line"><a id="l00045" name="l00045"></a><span class="lineno"><a class="line" href="a199780.html#a9fb8a2c5549375ee361f13293aae5e29">   45</a></span>        self.<a class="code hl_variable" href="a199780.html#a9fb8a2c5549375ee361f13293aae5e29">_next_idx</a> = 0</div>
<div class="line"><a id="l00046" name="l00046"></a><span class="lineno"><a class="line" href="a199780.html#aec1995d16f3c04e0c1a9e0316a3c100d">   46</a></span>        self.<a class="code hl_variable" href="a199780.html#aec1995d16f3c04e0c1a9e0316a3c100d">_data_count</a> = 0</div>
<div class="line"><a id="l00047" name="l00047"></a><span class="lineno"><a class="line" href="a199780.html#aac4ec8d53ada4ad43240eb8010e7e465">   47</a></span>        self.<a class="code hl_variable" href="a199780.html#aac4ec8d53ada4ad43240eb8010e7e465">_total_data_count</a> = 0</div>
<div class="line"><a id="l00048" name="l00048"></a><span class="lineno"><a class="line" href="a199780.html#a158dfcb175ae120c96b8bbf54a8130cb">   48</a></span>        self.<a class="code hl_variable" href="a199780.html#a158dfcb175ae120c96b8bbf54a8130cb">ep_indices</a> = [(0,0) <span class="keywordflow">for</span> _ <span class="keywordflow">in</span> range(self.<a class="code hl_variable" href="a199780.html#a910e8a532380740b9062313fb70ba15c">capacity</a>)]</div>
<div class="line"><a id="l00049" name="l00049"></a><span class="lineno"><a class="line" href="a199780.html#a6207eddde0abb9c65862e06c5c0f63c9">   49</a></span>        self.<a class="code hl_variable" href="a199780.html#a6207eddde0abb9c65862e06c5c0f63c9">flat_idx_from_ep</a> = collections.defaultdict(<span class="keyword">lambda</span>: collections.defaultdict(<span class="keyword">lambda</span>: <span class="keywordtype">None</span>))</div>
<div class="line"><a id="l00050" name="l00050"></a><span class="lineno"><a class="line" href="a199780.html#a8300bfd589d70b9df2567e136366bb50">   50</a></span>        self.<a class="code hl_variable" href="a199780.html#a8300bfd589d70b9df2567e136366bb50">inputs_zeros</a>={}</div>
<div class="line"><a id="l00051" name="l00051"></a><span class="lineno"><a class="line" href="a199780.html#afb253b7a600a7a1771e96414e9814e04">   51</a></span>        self.<a class="code hl_variable" href="a199780.html#afb253b7a600a7a1771e96414e9814e04">truth_zeros</a>={}</div>
<div class="line"><a id="l00052" name="l00052"></a><span class="lineno">   52</span>        obs_zeros = map_r(self.<a class="code hl_variable" href="a199780.html#a59231da590ccbb649314e4a7bb35da12">args</a>[<span class="stringliteral">&#39;observation_space&#39;</span>].sample(), <span class="keyword">lambda</span> x: np.zeros_like(x))</div>
<div class="line"><a id="l00053" name="l00053"></a><span class="lineno">   53</span>        <span class="keywordflow">for</span> name,task <span class="keywordflow">in</span> self.<a class="code hl_variable" href="a199780.html#adf5db3bb5a72111421f305a8bce645e8">tasks</a>.items():</div>
<div class="line"><a id="l00054" name="l00054"></a><span class="lineno">   54</span>            if(name+<span class="stringliteral">&#39;_input&#39;</span> <span class="keywordflow">in</span> obs_zeros):</div>
<div class="line"><a id="l00055" name="l00055"></a><span class="lineno">   55</span>                self.<a class="code hl_variable" href="a199780.html#a8300bfd589d70b9df2567e136366bb50">inputs_zeros</a>[name]=obs_zeros[name+<span class="stringliteral">&#39;_input&#39;</span>]</div>
<div class="line"><a id="l00056" name="l00056"></a><span class="lineno">   56</span>            if(<span class="stringliteral">&#39;original&#39;</span> <span class="keywordflow">in</span> obs_zeros):</div>
<div class="line"><a id="l00057" name="l00057"></a><span class="lineno">   57</span>                obs_zeros=obs_zeros[<span class="stringliteral">&#39;original&#39;</span>]</div>
<div class="line"><a id="l00058" name="l00058"></a><span class="lineno">   58</span>            <span class="keywordflow">else</span>:</div>
<div class="line"><a id="l00059" name="l00059"></a><span class="lineno">   59</span>                aux_keys=[k <span class="keywordflow">for</span> k <span class="keywordflow">in</span> obs_zeros <span class="keywordflow">if</span> k.endswith(<span class="stringliteral">&#39;_input&#39;</span>)]</div>
<div class="line"><a id="l00060" name="l00060"></a><span class="lineno">   60</span>                obs_zeros={k:v <span class="keywordflow">for</span> k,v <span class="keywordflow">in</span> obs_zeros.items() <span class="keywordflow">if</span> k <span class="keywordflow">not</span> <span class="keywordflow">in</span> aux_keys}</div>
<div class="line"><a id="l00061" name="l00061"></a><span class="lineno">   61</span>            self.<a class="code hl_variable" href="a199780.html#a8300bfd589d70b9df2567e136366bb50">inputs_zeros</a>[<span class="stringliteral">&#39;original&#39;</span>]=obs_zeros</div>
<div class="line"><a id="l00062" name="l00062"></a><span class="lineno">   62</span>            if(name <span class="keywordflow">in</span> self.<a class="code hl_variable" href="a199780.html#a59231da590ccbb649314e4a7bb35da12">args</a>[<span class="stringliteral">&#39;auxiliary_task_truth_space&#39;</span>]):</div>
<div class="line"><a id="l00063" name="l00063"></a><span class="lineno">   63</span>                self.<a class="code hl_variable" href="a199780.html#afb253b7a600a7a1771e96414e9814e04">truth_zeros</a>[name]=map_r(self.<a class="code hl_variable" href="a199780.html#a59231da590ccbb649314e4a7bb35da12">args</a>[<span class="stringliteral">&#39;auxiliary_task_truth_space&#39;</span>][name].sample(),<span class="keyword">lambda</span> x:np.zeros_like(x))</div>
</div>
<div class="foldopen" id="foldopen00064" data-start="" data-end="">
<div class="line"><a id="l00064" name="l00064"></a><span class="lineno"><a class="line" href="a199780.html#a1deb9d315d2982bb12398a78f839950a">   64</a></span>    <span class="keyword">def </span><a class="code hl_function" href="a199780.html#a1deb9d315d2982bb12398a78f839950a">extract_data</a>(self,ep):</div>
<div class="line"><a id="l00065" name="l00065"></a><span class="lineno">   65</span>        moments = sum([cloudpickle.loads(bz2.decompress(ms)) <span class="keywordflow">for</span> ms <span class="keywordflow">in</span> ep[<span class="stringliteral">&#39;moment&#39;</span>]], [])</div>
<div class="line"><a id="l00066" name="l00066"></a><span class="lineno">   66</span>        players = [idx <span class="keywordflow">for</span> idx, policy <span class="keywordflow">in</span> enumerate(ep[<span class="stringliteral">&#39;policy_map&#39;</span>])</div>
<div class="line"><a id="l00067" name="l00067"></a><span class="lineno">   67</span>            <span class="keywordflow">if</span> policy <span class="keywordflow">in</span> [self.<a class="code hl_variable" href="a199780.html#a3d67fe9f78b92dd308cd43f6b8588b2c">policy_to_train</a>] + [<span class="stringliteral">&#39;Imitator&#39;</span>]</div>
<div class="line"><a id="l00068" name="l00068"></a><span class="lineno">   68</span>        ]</div>
<div class="line"><a id="l00069" name="l00069"></a><span class="lineno">   69</span>        <span class="keywordflow">if</span> len(players) ==0:</div>
<div class="line"><a id="l00070" name="l00070"></a><span class="lineno">   70</span>            <span class="comment">#学習対象のpolicyが含まれない</span></div>
<div class="line"><a id="l00071" name="l00071"></a><span class="lineno">   71</span>            <span class="keywordflow">return</span> <span class="keywordtype">None</span></div>
<div class="line"><a id="l00072" name="l00072"></a><span class="lineno">   72</span> </div>
<div class="line"><a id="l00073" name="l00073"></a><span class="lineno">   73</span>        <span class="comment">#observationからのinputsの抽出</span></div>
<div class="line"><a id="l00074" name="l00074"></a><span class="lineno">   74</span>        obs_zeros = map_r(self.<a class="code hl_variable" href="a199780.html#a59231da590ccbb649314e4a7bb35da12">args</a>[<span class="stringliteral">&#39;observation_space&#39;</span>].sample(), <span class="keyword">lambda</span> x: np.zeros_like(x))</div>
<div class="line"><a id="l00075" name="l00075"></a><span class="lineno">   75</span>        obs = [[<a class="code hl_function" href="a197806.html#a9730abcd04ed275abbd43267a5e9e887">replace_none</a>(m[<span class="stringliteral">&#39;observation&#39;</span>][player], obs_zeros) <span class="keywordflow">for</span> player <span class="keywordflow">in</span> players] <span class="keywordflow">for</span> m <span class="keywordflow">in</span> moments]</div>
<div class="line"><a id="l00076" name="l00076"></a><span class="lineno">   76</span>        obs = rotate(rotate(obs))  <span class="comment"># (T, P, ..., ...) -&gt; (P, ..., T, ...) -&gt; (..., T, P, ...)</span></div>
<div class="line"><a id="l00077" name="l00077"></a><span class="lineno">   77</span>        obs = bimap_r(obs_zeros, obs, <span class="keyword">lambda</span> _, o: np.array(o))</div>
<div class="line"><a id="l00078" name="l00078"></a><span class="lineno">   78</span>        mask = np.array([[[m[<span class="stringliteral">&#39;observation&#39;</span>][player] <span class="keywordflow">is</span> <span class="keywordflow">not</span> <span class="keywordtype">None</span>] <span class="keywordflow">for</span> player <span class="keywordflow">in</span> players] <span class="keywordflow">for</span> m <span class="keywordflow">in</span> moments], dtype=np.float32)</div>
<div class="line"><a id="l00079" name="l00079"></a><span class="lineno">   79</span>        assert(isinstance(obs,dict))</div>
<div class="line"><a id="l00080" name="l00080"></a><span class="lineno">   80</span>        inputs={}</div>
<div class="line"><a id="l00081" name="l00081"></a><span class="lineno">   81</span>        <span class="keywordflow">for</span> name,task <span class="keywordflow">in</span> self.<a class="code hl_variable" href="a199780.html#adf5db3bb5a72111421f305a8bce645e8">tasks</a>.items():</div>
<div class="line"><a id="l00082" name="l00082"></a><span class="lineno">   82</span>            if(name+<span class="stringliteral">&#39;_input&#39;</span> <span class="keywordflow">in</span> obs):</div>
<div class="line"><a id="l00083" name="l00083"></a><span class="lineno">   83</span>                inputs[name]=obs[name+<span class="stringliteral">&#39;_input&#39;</span>]</div>
<div class="line"><a id="l00084" name="l00084"></a><span class="lineno">   84</span>            if(<span class="stringliteral">&#39;original&#39;</span> <span class="keywordflow">in</span> obs):</div>
<div class="line"><a id="l00085" name="l00085"></a><span class="lineno">   85</span>                obs=obs[<span class="stringliteral">&#39;original&#39;</span>]</div>
<div class="line"><a id="l00086" name="l00086"></a><span class="lineno">   86</span>            <span class="keywordflow">else</span>:</div>
<div class="line"><a id="l00087" name="l00087"></a><span class="lineno">   87</span>                aux_keys=[k <span class="keywordflow">for</span> k <span class="keywordflow">in</span> obs <span class="keywordflow">if</span> k.endswith(<span class="stringliteral">&#39;_input&#39;</span>)]</div>
<div class="line"><a id="l00088" name="l00088"></a><span class="lineno">   88</span>                obs={k:v <span class="keywordflow">for</span> k,v <span class="keywordflow">in</span> obs.items() <span class="keywordflow">if</span> k <span class="keywordflow">not</span> <span class="keywordflow">in</span> aux_keys}</div>
<div class="line"><a id="l00089" name="l00089"></a><span class="lineno">   89</span>            inputs[<span class="stringliteral">&#39;original&#39;</span>]=obs</div>
<div class="line"><a id="l00090" name="l00090"></a><span class="lineno">   90</span>        <span class="comment">#truthの抽出</span></div>
<div class="line"><a id="l00091" name="l00091"></a><span class="lineno">   91</span>        truths={}</div>
<div class="line"><a id="l00092" name="l00092"></a><span class="lineno">   92</span>        <span class="keywordflow">for</span> name,task <span class="keywordflow">in</span> self.<a class="code hl_variable" href="a199780.html#adf5db3bb5a72111421f305a8bce645e8">tasks</a>.items():</div>
<div class="line"><a id="l00093" name="l00093"></a><span class="lineno">   93</span>            if(name <span class="keywordflow">in</span> self.<a class="code hl_variable" href="a199780.html#afb253b7a600a7a1771e96414e9814e04">truth_zeros</a>):</div>
<div class="line"><a id="l00094" name="l00094"></a><span class="lineno">   94</span>                truth = [[<a class="code hl_function" href="a197806.html#a9730abcd04ed275abbd43267a5e9e887">replace_none</a>(t.get(player,<span class="keywordtype">None</span>), self.<a class="code hl_variable" href="a199780.html#afb253b7a600a7a1771e96414e9814e04">truth_zeros</a>[name]) <span class="keywordflow">for</span> player <span class="keywordflow">in</span> players] <span class="keywordflow">for</span> t <span class="keywordflow">in</span> ep[<span class="stringliteral">&#39;auxiliary_task_truth&#39;</span>][name]]</div>
<div class="line"><a id="l00095" name="l00095"></a><span class="lineno">   95</span>                truth = rotate(rotate(truth))  <span class="comment"># (T, P, ..., ...) -&gt; (P, ..., T, ...) -&gt; (..., T, P, ...)</span></div>
<div class="line"><a id="l00096" name="l00096"></a><span class="lineno">   96</span>                truth = bimap_r(self.<a class="code hl_variable" href="a199780.html#afb253b7a600a7a1771e96414e9814e04">truth_zeros</a>[name], truth, <span class="keyword">lambda</span> _, t: np.array(t))</div>
<div class="line"><a id="l00097" name="l00097"></a><span class="lineno">   97</span>                truths[name]=truth</div>
<div class="line"><a id="l00098" name="l00098"></a><span class="lineno">   98</span>        <span class="keywordflow">return</span> {</div>
<div class="line"><a id="l00099" name="l00099"></a><span class="lineno">   99</span>            <span class="stringliteral">&#39;args&#39;</span>: ep[<span class="stringliteral">&#39;args&#39;</span>], <span class="stringliteral">&#39;outcome&#39;</span>: ep[<span class="stringliteral">&#39;outcome&#39;</span>],</div>
<div class="line"><a id="l00100" name="l00100"></a><span class="lineno">  100</span>            <span class="stringliteral">&#39;steps&#39;</span>: ep[<span class="stringliteral">&#39;steps&#39;</span>],</div>
<div class="line"><a id="l00101" name="l00101"></a><span class="lineno">  101</span>            <span class="stringliteral">&#39;policy_map&#39;</span>: ep[<span class="stringliteral">&#39;policy_map&#39;</span>],</div>
<div class="line"><a id="l00102" name="l00102"></a><span class="lineno">  102</span> </div>
<div class="line"><a id="l00103" name="l00103"></a><span class="lineno">  103</span>            <span class="stringliteral">&#39;inputs&#39;</span>:inputs,</div>
<div class="line"><a id="l00104" name="l00104"></a><span class="lineno">  104</span>            <span class="stringliteral">&#39;truths&#39;</span>:truths,</div>
<div class="line"><a id="l00105" name="l00105"></a><span class="lineno">  105</span>            <span class="stringliteral">&#39;mask&#39;</span>:mask,</div>
<div class="line"><a id="l00106" name="l00106"></a><span class="lineno">  106</span>        }</div>
</div>
<div class="foldopen" id="foldopen00107" data-start="" data-end="">
<div class="line"><a id="l00107" name="l00107"></a><span class="lineno"><a class="line" href="a199780.html#a0a60f1cd30c17bb2be5ab3667051526f">  107</a></span>    <span class="keyword">def </span><a class="code hl_function" href="a199780.html#a0a60f1cd30c17bb2be5ab3667051526f">add_episodes</a>(self,episodes):</div>
<div class="line"><a id="l00108" name="l00108"></a><span class="lineno">  108</span>        ep_cnt = 0</div>
<div class="line"><a id="l00109" name="l00109"></a><span class="lineno">  109</span>        <span class="keywordflow">for</span> ep <span class="keywordflow">in</span> episodes:</div>
<div class="line"><a id="l00110" name="l00110"></a><span class="lineno">  110</span>            extracted=self.<a class="code hl_function" href="a199780.html#a1deb9d315d2982bb12398a78f839950a">extract_data</a>(ep)</div>
<div class="line"><a id="l00111" name="l00111"></a><span class="lineno">  111</span>            if(extracted <span class="keywordflow">is</span> <span class="keywordtype">None</span>):</div>
<div class="line"><a id="l00112" name="l00112"></a><span class="lineno">  112</span>                <span class="keywordflow">continue</span></div>
<div class="line"><a id="l00113" name="l00113"></a><span class="lineno">  113</span>            self.<a class="code hl_variable" href="a199780.html#a2af5a32a89659aa800f6570e5568488d">episodes</a>.append(extracted)</div>
<div class="line"><a id="l00114" name="l00114"></a><span class="lineno">  114</span>            num_candidates = 1 + max(0, ep[<span class="stringliteral">&#39;steps&#39;</span>] - self.<a class="code hl_variable" href="a199780.html#a59231da590ccbb649314e4a7bb35da12">args</a>[<span class="stringliteral">&#39;forward_steps&#39;</span>])</div>
<div class="line"><a id="l00115" name="l00115"></a><span class="lineno">  115</span>            <span class="keywordflow">for</span> train_st <span class="keywordflow">in</span> range(num_candidates):</div>
<div class="line"><a id="l00116" name="l00116"></a><span class="lineno">  116</span>                ep_idx = self.<a class="code hl_variable" href="a199780.html#aaa902cc6cff5982fd00c82282f50ad0f">_ep_idx_ofs</a> + len(self.<a class="code hl_variable" href="a199780.html#a2af5a32a89659aa800f6570e5568488d">episodes</a>) - 1</div>
<div class="line"><a id="l00117" name="l00117"></a><span class="lineno">  117</span>                self.<a class="code hl_variable" href="a199780.html#a158dfcb175ae120c96b8bbf54a8130cb">ep_indices</a>[self.<a class="code hl_variable" href="a199780.html#a9fb8a2c5549375ee361f13293aae5e29">_next_idx</a>]=(ep_idx, train_st)</div>
<div class="line"><a id="l00118" name="l00118"></a><span class="lineno">  118</span>                self.<a class="code hl_variable" href="a199780.html#a6207eddde0abb9c65862e06c5c0f63c9">flat_idx_from_ep</a>[ep_idx][train_st] = self.<a class="code hl_variable" href="a199780.html#a9fb8a2c5549375ee361f13293aae5e29">_next_idx</a></div>
<div class="line"><a id="l00119" name="l00119"></a><span class="lineno">  119</span>                self.<a class="code hl_variable" href="a199780.html#a9fb8a2c5549375ee361f13293aae5e29">_next_idx</a> += 1</div>
<div class="line"><a id="l00120" name="l00120"></a><span class="lineno">  120</span>                self.<a class="code hl_variable" href="a199780.html#aec1995d16f3c04e0c1a9e0316a3c100d">_data_count</a> = min(self.<a class="code hl_variable" href="a199780.html#aec1995d16f3c04e0c1a9e0316a3c100d">_data_count</a> + 1, self.<a class="code hl_variable" href="a199780.html#a910e8a532380740b9062313fb70ba15c">capacity</a>)</div>
<div class="line"><a id="l00121" name="l00121"></a><span class="lineno">  121</span>                self.<a class="code hl_variable" href="a199780.html#aac4ec8d53ada4ad43240eb8010e7e465">_total_data_count</a> += 1</div>
<div class="line"><a id="l00122" name="l00122"></a><span class="lineno">  122</span>                <span class="keywordflow">if</span> self.<a class="code hl_variable" href="a199780.html#a9fb8a2c5549375ee361f13293aae5e29">_next_idx</a> &gt;= self.<a class="code hl_variable" href="a199780.html#a910e8a532380740b9062313fb70ba15c">capacity</a>:</div>
<div class="line"><a id="l00123" name="l00123"></a><span class="lineno">  123</span>                    self.<a class="code hl_variable" href="a199780.html#a9fb8a2c5549375ee361f13293aae5e29">_next_idx</a> = 0</div>
<div class="line"><a id="l00124" name="l00124"></a><span class="lineno">  124</span>            ep_cnt += 1</div>
<div class="line"><a id="l00125" name="l00125"></a><span class="lineno">  125</span>        <span class="keywordflow">while</span> self.<a class="code hl_variable" href="a199780.html#a158dfcb175ae120c96b8bbf54a8130cb">ep_indices</a>[self.<a class="code hl_variable" href="a199780.html#a9fb8a2c5549375ee361f13293aae5e29">_next_idx</a>][0] &gt; self.<a class="code hl_variable" href="a199780.html#aaa902cc6cff5982fd00c82282f50ad0f">_ep_idx_ofs</a>:</div>
<div class="line"><a id="l00126" name="l00126"></a><span class="lineno">  126</span>            self.<a class="code hl_variable" href="a199780.html#a6207eddde0abb9c65862e06c5c0f63c9">flat_idx_from_ep</a>.pop(self.<a class="code hl_variable" href="a199780.html#aaa902cc6cff5982fd00c82282f50ad0f">_ep_idx_ofs</a>)</div>
<div class="line"><a id="l00127" name="l00127"></a><span class="lineno">  127</span>            self.<a class="code hl_variable" href="a199780.html#aaa902cc6cff5982fd00c82282f50ad0f">_ep_idx_ofs</a> += 1</div>
<div class="line"><a id="l00128" name="l00128"></a><span class="lineno">  128</span>            self.<a class="code hl_variable" href="a199780.html#a2af5a32a89659aa800f6570e5568488d">episodes</a>.popleft()</div>
</div>
<div class="foldopen" id="foldopen00129" data-start="" data-end="">
<div class="line"><a id="l00129" name="l00129"></a><span class="lineno"><a class="line" href="a199780.html#a3821ebdc2c9dff3432c1929915effd29">  129</a></span>    <span class="keyword">def </span><a class="code hl_function" href="a199780.html#a3821ebdc2c9dff3432c1929915effd29">get_episode</a>(self,ep_idx):</div>
<div class="line"><a id="l00130" name="l00130"></a><span class="lineno">  130</span>        <span class="keywordflow">return</span> self.<a class="code hl_variable" href="a199780.html#a2af5a32a89659aa800f6570e5568488d">episodes</a>[ep_idx-self.<a class="code hl_variable" href="a199780.html#aaa902cc6cff5982fd00c82282f50ad0f">_ep_idx_ofs</a>]</div>
</div>
<div class="foldopen" id="foldopen00131" data-start="" data-end="">
<div class="line"><a id="l00131" name="l00131"></a><span class="lineno"><a class="line" href="a199780.html#a649525d8b466e5bae1c2e5d77355c0cb">  131</a></span>    <span class="keyword">def </span><a class="code hl_function" href="a199780.html#a649525d8b466e5bae1c2e5d77355c0cb">get_idx_candidates</a>(self):</div>
<div class="line"><a id="l00132" name="l00132"></a><span class="lineno">  132</span>        <span class="keywordflow">return</span> self.<a class="code hl_variable" href="a199780.html#a6207eddde0abb9c65862e06c5c0f63c9">flat_idx_from_ep</a></div>
</div>
<div class="foldopen" id="foldopen00133" data-start="" data-end="">
<div class="line"><a id="l00133" name="l00133"></a><span class="lineno"><a class="line" href="a199780.html#afd8f198150b750d7785ff27b20c930ce">  133</a></span>    <span class="keyword">def </span><a class="code hl_function" href="a199780.html#afd8f198150b750d7785ff27b20c930ce">__getitem__</a>(self,idx):</div>
<div class="line"><a id="l00134" name="l00134"></a><span class="lineno">  134</span>        ep_idx, train_st = self.<a class="code hl_variable" href="a199780.html#a158dfcb175ae120c96b8bbf54a8130cb">ep_indices</a>[idx]</div>
<div class="line"><a id="l00135" name="l00135"></a><span class="lineno">  135</span>        ep = self.<a class="code hl_function" href="a199780.html#a3821ebdc2c9dff3432c1929915effd29">get_episode</a>(ep_idx)</div>
<div class="line"><a id="l00136" name="l00136"></a><span class="lineno">  136</span>        st = max(0, train_st - self.<a class="code hl_variable" href="a199780.html#a59231da590ccbb649314e4a7bb35da12">args</a>[<span class="stringliteral">&#39;burn_in_steps&#39;</span>])</div>
<div class="line"><a id="l00137" name="l00137"></a><span class="lineno">  137</span>        ed = min(train_st + self.<a class="code hl_variable" href="a199780.html#a59231da590ccbb649314e4a7bb35da12">args</a>[<span class="stringliteral">&#39;forward_steps&#39;</span>], ep[<span class="stringliteral">&#39;steps&#39;</span>])</div>
<div class="line"><a id="l00138" name="l00138"></a><span class="lineno">  138</span>        st_block = st // self.<a class="code hl_variable" href="a199780.html#a59231da590ccbb649314e4a7bb35da12">args</a>[<span class="stringliteral">&#39;compress_steps&#39;</span>]</div>
<div class="line"><a id="l00139" name="l00139"></a><span class="lineno">  139</span>        ed_block = (ed - 1) // self.<a class="code hl_variable" href="a199780.html#a59231da590ccbb649314e4a7bb35da12">args</a>[<span class="stringliteral">&#39;compress_steps&#39;</span>] + 1</div>
<div class="line"><a id="l00140" name="l00140"></a><span class="lineno">  140</span>        <span class="keywordflow">return</span> {</div>
<div class="line"><a id="l00141" name="l00141"></a><span class="lineno">  141</span>            <span class="stringliteral">&#39;args&#39;</span>: ep[<span class="stringliteral">&#39;args&#39;</span>], <span class="stringliteral">&#39;outcome&#39;</span>: ep[<span class="stringliteral">&#39;outcome&#39;</span>],</div>
<div class="line"><a id="l00142" name="l00142"></a><span class="lineno">  142</span>            <span class="stringliteral">&#39;inputs&#39;</span>:map_r(ep[<span class="stringliteral">&#39;inputs&#39;</span>],<span class="keyword">lambda</span> x:x[st:ed]),</div>
<div class="line"><a id="l00143" name="l00143"></a><span class="lineno">  143</span>            <span class="stringliteral">&#39;truths&#39;</span>:map_r(ep[<span class="stringliteral">&#39;truths&#39;</span>],<span class="keyword">lambda</span> x:x[st:ed]),</div>
<div class="line"><a id="l00144" name="l00144"></a><span class="lineno">  144</span>            <span class="stringliteral">&#39;mask&#39;</span>:ep[<span class="stringliteral">&#39;mask&#39;</span>][st:ed],</div>
<div class="line"><a id="l00145" name="l00145"></a><span class="lineno">  145</span>            <span class="stringliteral">&#39;ep_idx&#39;</span>: ep_idx, <span class="stringliteral">&#39;start&#39;</span>: st, <span class="stringliteral">&#39;end&#39;</span>: ed, <span class="stringliteral">&#39;train_start&#39;</span>: train_st, <span class="stringliteral">&#39;total&#39;</span>: ep[<span class="stringliteral">&#39;steps&#39;</span>],</div>
<div class="line"><a id="l00146" name="l00146"></a><span class="lineno">  146</span>            <span class="stringliteral">&#39;policy_map&#39;</span>: ep[<span class="stringliteral">&#39;policy_map&#39;</span>],</div>
<div class="line"><a id="l00147" name="l00147"></a><span class="lineno">  147</span>        }</div>
</div>
<div class="foldopen" id="foldopen00148" data-start="" data-end="">
<div class="line"><a id="l00148" name="l00148"></a><span class="lineno"><a class="line" href="a199780.html#a40650e44a8d452b40ae547149d7fa216">  148</a></span>    <span class="keyword">def </span><a class="code hl_function" href="a199780.html#a40650e44a8d452b40ae547149d7fa216">make_batch</a>(self,task_name,episodes):</div>
<div class="line"><a id="l00149" name="l00149"></a><span class="lineno">  149</span>        inputs_tot=[]</div>
<div class="line"><a id="l00150" name="l00150"></a><span class="lineno">  150</span>        truth_tot=[]</div>
<div class="line"><a id="l00151" name="l00151"></a><span class="lineno">  151</span>        mask_tot=[]</div>
<div class="line"><a id="l00152" name="l00152"></a><span class="lineno">  152</span>        <span class="keywordflow">for</span> ep <span class="keywordflow">in</span> episodes:</div>
<div class="line"><a id="l00153" name="l00153"></a><span class="lineno">  153</span>            key = task_name <span class="keywordflow">if</span> task_name <span class="keywordflow">in</span> ep[<span class="stringliteral">&#39;inputs&#39;</span>] <span class="keywordflow">else</span> <span class="stringliteral">&#39;original&#39;</span></div>
<div class="line"><a id="l00154" name="l00154"></a><span class="lineno">  154</span>            inputs = ep[<span class="stringliteral">&#39;inputs&#39;</span>][key][:ep[<span class="stringliteral">&#39;end&#39;</span>] - ep[<span class="stringliteral">&#39;start&#39;</span>]]</div>
<div class="line"><a id="l00155" name="l00155"></a><span class="lineno">  155</span>            <span class="keywordflow">if</span> task_name <span class="keywordflow">in</span> self.<a class="code hl_variable" href="a199780.html#afb253b7a600a7a1771e96414e9814e04">truth_zeros</a>:</div>
<div class="line"><a id="l00156" name="l00156"></a><span class="lineno">  156</span>                truth = ep[<span class="stringliteral">&#39;truths&#39;</span>][task_name][:ep[<span class="stringliteral">&#39;end&#39;</span>] - ep[<span class="stringliteral">&#39;start&#39;</span>]]</div>
<div class="line"><a id="l00157" name="l00157"></a><span class="lineno">  157</span>            mask = ep[<span class="stringliteral">&#39;mask&#39;</span>][:ep[<span class="stringliteral">&#39;end&#39;</span>] - ep[<span class="stringliteral">&#39;start&#39;</span>]]</div>
<div class="line"><a id="l00158" name="l00158"></a><span class="lineno">  158</span> </div>
<div class="line"><a id="l00159" name="l00159"></a><span class="lineno">  159</span>            <span class="comment"># pad each array if step length is short</span></div>
<div class="line"><a id="l00160" name="l00160"></a><span class="lineno">  160</span>            batch_steps = self.<a class="code hl_variable" href="a199780.html#a59231da590ccbb649314e4a7bb35da12">args</a>[<span class="stringliteral">&#39;burn_in_steps&#39;</span>] + self.<a class="code hl_variable" href="a199780.html#a59231da590ccbb649314e4a7bb35da12">args</a>[<span class="stringliteral">&#39;forward_steps&#39;</span>]</div>
<div class="line"><a id="l00161" name="l00161"></a><span class="lineno">  161</span>            <span class="keywordflow">if</span> len(mask) &lt; batch_steps:</div>
<div class="line"><a id="l00162" name="l00162"></a><span class="lineno">  162</span>                pad_len_b = self.<a class="code hl_variable" href="a199780.html#a59231da590ccbb649314e4a7bb35da12">args</a>[<span class="stringliteral">&#39;burn_in_steps&#39;</span>] - (ep[<span class="stringliteral">&#39;train_start&#39;</span>] - ep[<span class="stringliteral">&#39;start&#39;</span>])</div>
<div class="line"><a id="l00163" name="l00163"></a><span class="lineno">  163</span>                pad_len_a = batch_steps - len(mask) - pad_len_b</div>
<div class="line"><a id="l00164" name="l00164"></a><span class="lineno">  164</span>                inputs = map_r(inputs, <span class="keyword">lambda</span> i: np.pad(i, [(pad_len_b, pad_len_a)] + [(0, 0)] * (len(i.shape) - 1), <span class="stringliteral">&#39;constant&#39;</span>, constant_values=0))</div>
<div class="line"><a id="l00165" name="l00165"></a><span class="lineno">  165</span>                <span class="keywordflow">if</span> task_name <span class="keywordflow">in</span> self.<a class="code hl_variable" href="a199780.html#afb253b7a600a7a1771e96414e9814e04">truth_zeros</a>:</div>
<div class="line"><a id="l00166" name="l00166"></a><span class="lineno">  166</span>                    truth = map_r(truth, <span class="keyword">lambda</span> t: np.pad(t, [(pad_len_b, pad_len_a)] + [(0, 0)] * (len(t.shape) - 1), <span class="stringliteral">&#39;constant&#39;</span>, constant_values=0))</div>
<div class="line"><a id="l00167" name="l00167"></a><span class="lineno">  167</span>                mask = np.pad(mask, [(pad_len_b, pad_len_a), (0, 0), (0, 0)], <span class="stringliteral">&#39;constant&#39;</span>, constant_values=0)</div>
<div class="line"><a id="l00168" name="l00168"></a><span class="lineno">  168</span>            inputs_tot.append(inputs)</div>
<div class="line"><a id="l00169" name="l00169"></a><span class="lineno">  169</span>            <span class="keywordflow">if</span> task_name <span class="keywordflow">in</span> self.<a class="code hl_variable" href="a199780.html#afb253b7a600a7a1771e96414e9814e04">truth_zeros</a>:</div>
<div class="line"><a id="l00170" name="l00170"></a><span class="lineno">  170</span>                truth_tot.append(truth)</div>
<div class="line"><a id="l00171" name="l00171"></a><span class="lineno">  171</span>            mask_tot.append(mask)</div>
<div class="line"><a id="l00172" name="l00172"></a><span class="lineno">  172</span>        inputs = <a class="code hl_function" href="a197806.html#a5870da1c12de129b123fe850ed84358e">to_torch</a>(bimap_r(self.<a class="code hl_variable" href="a199780.html#a8300bfd589d70b9df2567e136366bb50">inputs_zeros</a>[key],rotate(inputs_tot), <span class="keyword">lambda</span> _, i: np.array(i)))</div>
<div class="line"><a id="l00173" name="l00173"></a><span class="lineno">  173</span>        <span class="keywordflow">if</span> task_name <span class="keywordflow">in</span> self.<a class="code hl_variable" href="a199780.html#afb253b7a600a7a1771e96414e9814e04">truth_zeros</a>:</div>
<div class="line"><a id="l00174" name="l00174"></a><span class="lineno">  174</span>            truth = <a class="code hl_function" href="a197806.html#a5870da1c12de129b123fe850ed84358e">to_torch</a>(bimap_r(self.<a class="code hl_variable" href="a199780.html#afb253b7a600a7a1771e96414e9814e04">truth_zeros</a>[key],rotate(truth_tot), <span class="keyword">lambda</span> _, t: np.array(t)))</div>
<div class="line"><a id="l00175" name="l00175"></a><span class="lineno">  175</span>        mask = <a class="code hl_function" href="a197806.html#a5870da1c12de129b123fe850ed84358e">to_torch</a>(np.array(mask_tot))</div>
<div class="line"><a id="l00176" name="l00176"></a><span class="lineno">  176</span>        <span class="keywordflow">return</span> {</div>
<div class="line"><a id="l00177" name="l00177"></a><span class="lineno">  177</span>            <span class="stringliteral">&#39;inputs&#39;</span>:inputs,</div>
<div class="line"><a id="l00178" name="l00178"></a><span class="lineno">  178</span>            <span class="stringliteral">&#39;truth&#39;</span>:truth,</div>
<div class="line"><a id="l00179" name="l00179"></a><span class="lineno">  179</span>            <span class="stringliteral">&#39;mask&#39;</span>:mask</div>
<div class="line"><a id="l00180" name="l00180"></a><span class="lineno">  180</span>        }</div>
</div>
<div class="foldopen" id="foldopen00181" data-start="" data-end="">
<div class="line"><a id="l00181" name="l00181"></a><span class="lineno"><a class="line" href="a199780.html#a6f308f993b6c14f39793528508a385f9">  181</a></span>    <span class="keyword">def </span><a class="code hl_function" href="a199780.html#a6f308f993b6c14f39793528508a385f9">forward</a>(self,model,batch):</div>
<div class="line"><a id="l00182" name="l00182"></a><span class="lineno">  182</span>        inputs = batch[<span class="stringliteral">&#39;inputs&#39;</span>]</div>
<div class="line"><a id="l00183" name="l00183"></a><span class="lineno">  183</span>        batch_shape = batch[<span class="stringliteral">&#39;mask&#39;</span>].size()[:3] <span class="comment"># (B, T, P or 1)</span></div>
<div class="line"><a id="l00184" name="l00184"></a><span class="lineno">  184</span>        hidden = batch.get(<span class="stringliteral">&#39;hidden_in&#39;</span>,<span class="keywordtype">None</span>)</div>
<div class="line"><a id="l00185" name="l00185"></a><span class="lineno">  185</span>        <span class="keywordflow">if</span> hidden <span class="keywordflow">is</span> <span class="keywordtype">None</span>:</div>
<div class="line"><a id="l00186" name="l00186"></a><span class="lineno">  186</span>            <span class="comment"># feed-forward neural network</span></div>
<div class="line"><a id="l00187" name="l00187"></a><span class="lineno">  187</span>            inputs = map_r(inputs, <span class="keyword">lambda</span> i: i.flatten(0, 2)) <span class="comment"># (..., B * T * P or 1, ...)</span></div>
<div class="line"><a id="l00188" name="l00188"></a><span class="lineno">  188</span>            outputs = <a class="code hl_variable" href="a199780.html#a55092b09b7f4711fd43833e9dbd8fcc0">model</a>(inputs, <span class="keywordtype">None</span>)</div>
<div class="line"><a id="l00189" name="l00189"></a><span class="lineno">  189</span>            outputs = map_r(outputs, <span class="keyword">lambda</span> o: o.unflatten(0, batch_shape))  <span class="comment"># (..., B, T, P or 1, ...)</span></div>
<div class="line"><a id="l00190" name="l00190"></a><span class="lineno">  190</span>        <span class="keywordflow">else</span>:</div>
<div class="line"><a id="l00191" name="l00191"></a><span class="lineno">  191</span>            <span class="comment"># sequential computation with RNN</span></div>
<div class="line"><a id="l00192" name="l00192"></a><span class="lineno">  192</span>            <span class="comment"># RNN block is assumed to be an instance of ASRCAISim1.plugins.HandyRLUtility.RecurrentBlock.RecurrentBlock</span></div>
<div class="line"><a id="l00193" name="l00193"></a><span class="lineno">  193</span>            outputs=[]</div>
<div class="line"><a id="l00194" name="l00194"></a><span class="lineno">  194</span>            seq_len = batch_shape[1]</div>
<div class="line"><a id="l00195" name="l00195"></a><span class="lineno">  195</span>            hidden = map_r(hidden, <span class="keyword">lambda</span> h: h.unsqueeze(0).unsqueeze(0).expand((batch_shape[0],batch_shape[2])+h.shape)) <span class="comment"># (..., B, P or 1, ...)</span></div>
<div class="line"><a id="l00196" name="l00196"></a><span class="lineno">  196</span>            inputs = map_r(inputs, <span class="keyword">lambda</span> i: i.transpose(1, 2))  <span class="comment"># (..., B , P or 1 , T, ...)</span></div>
<div class="line"><a id="l00197" name="l00197"></a><span class="lineno">  197</span>            mask_ = map_r(batch[<span class="stringliteral">&#39;mask&#39;</span>], <span class="keyword">lambda</span> m: m.transpose(1, 2))  <span class="comment"># (..., B , P or 1 , T, ...)</span></div>
<div class="line"><a id="l00198" name="l00198"></a><span class="lineno">  198</span>            mask = map_r(hidden, <span class="keyword">lambda</span> h: mask_.view([*h.size()[:2], seq_len, *([1] * (h.dim() - 2))]).flatten(0,1))</div>
<div class="line"><a id="l00199" name="l00199"></a><span class="lineno">  199</span>            hidden_ = map_r(hidden, <span class="keyword">lambda</span> h: h.flatten(0, 1))  <span class="comment"># (..., B * P or 1, ...)</span></div>
<div class="line"><a id="l00200" name="l00200"></a><span class="lineno">  200</span>            <span class="keywordflow">if</span> self.<a class="code hl_variable" href="a199780.html#a59231da590ccbb649314e4a7bb35da12">args</a>[<span class="stringliteral">&#39;burn_in_steps&#39;</span>] &gt;0 :</div>
<div class="line"><a id="l00201" name="l00201"></a><span class="lineno">  201</span>                model.eval()</div>
<div class="line"><a id="l00202" name="l00202"></a><span class="lineno">  202</span>                <span class="keyword">with</span> torch.no_grad():</div>
<div class="line"><a id="l00203" name="l00203"></a><span class="lineno">  203</span>                    outputs_, hidden_ = <a class="code hl_variable" href="a199780.html#a55092b09b7f4711fd43833e9dbd8fcc0">model</a>(map_r(inputs, <span class="keyword">lambda</span> i:i[:, :, :self.<a class="code hl_variable" href="a199780.html#a59231da590ccbb649314e4a7bb35da12">args</a>[<span class="stringliteral">&#39;burn_in_steps&#39;</span>], ...].flatten(0, 2)), hidden_, self.<a class="code hl_variable" href="a199780.html#a59231da590ccbb649314e4a7bb35da12">args</a>[<span class="stringliteral">&#39;burn_in_steps&#39;</span>],mask=map_r(mask,<span class="keyword">lambda</span> m: m[:,:self.<a class="code hl_variable" href="a199780.html#a59231da590ccbb649314e4a7bb35da12">args</a>[<span class="stringliteral">&#39;burn_in_steps&#39;</span>],...]))</div>
<div class="line"><a id="l00204" name="l00204"></a><span class="lineno">  204</span>                outputs_ = map_r(outputs_, <span class="keyword">lambda</span> o: o.unflatten(0, (batch_shape[0], batch_shape[2], self.<a class="code hl_variable" href="a199780.html#a59231da590ccbb649314e4a7bb35da12">args</a>[<span class="stringliteral">&#39;burn_in_steps&#39;</span>])).transpose(1, 2))</div>
<div class="line"><a id="l00205" name="l00205"></a><span class="lineno">  205</span>                outputs.append(outputs_)</div>
<div class="line"><a id="l00206" name="l00206"></a><span class="lineno">  206</span>            <span class="keywordflow">if</span> <span class="keywordflow">not</span> model.training:</div>
<div class="line"><a id="l00207" name="l00207"></a><span class="lineno">  207</span>                model.train()</div>
<div class="line"><a id="l00208" name="l00208"></a><span class="lineno">  208</span>            outputs_, hidden_ = <a class="code hl_variable" href="a199780.html#a55092b09b7f4711fd43833e9dbd8fcc0">model</a>(map_r(inputs, <span class="keyword">lambda</span> i:i[:, :, self.<a class="code hl_variable" href="a199780.html#a59231da590ccbb649314e4a7bb35da12">args</a>[<span class="stringliteral">&#39;burn_in_steps&#39;</span>]:, ...].flatten(0, 2)), hidden_,seq_len-self.<a class="code hl_variable" href="a199780.html#a59231da590ccbb649314e4a7bb35da12">args</a>[<span class="stringliteral">&#39;burn_in_steps&#39;</span>],mask=map_r(mask,<span class="keyword">lambda</span> m: m[:,self.<a class="code hl_variable" href="a199780.html#a59231da590ccbb649314e4a7bb35da12">args</a>[<span class="stringliteral">&#39;burn_in_steps&#39;</span>]:,...]))</div>
<div class="line"><a id="l00209" name="l00209"></a><span class="lineno">  209</span>            outputs_ = map_r(outputs_, <span class="keyword">lambda</span> o: o.unflatten(0, (batch_shape[0], batch_shape[2], seq_len-self.<a class="code hl_variable" href="a199780.html#a59231da590ccbb649314e4a7bb35da12">args</a>[<span class="stringliteral">&#39;burn_in_steps&#39;</span>])).transpose(1, 2))</div>
<div class="line"><a id="l00210" name="l00210"></a><span class="lineno">  210</span>            outputs.append(outputs_)</div>
<div class="line"><a id="l00211" name="l00211"></a><span class="lineno">  211</span>            outputs = torch.cat(outputs, dim=1).mul(batch[<span class="stringliteral">&#39;mask&#39;</span>])</div>
<div class="line"><a id="l00212" name="l00212"></a><span class="lineno">  212</span>        <span class="keywordflow">return</span> outputs</div>
</div>
<div class="foldopen" id="foldopen00213" data-start="" data-end="">
<div class="line"><a id="l00213" name="l00213"></a><span class="lineno"><a class="line" href="a199780.html#a2c101d6d2941ab9bf2f5f5a4593197e3">  213</a></span>    <span class="keyword">def </span><a class="code hl_function" href="a199780.html#a2c101d6d2941ab9bf2f5f5a4593197e3">train</a>(self):</div>
<div class="line"><a id="l00214" name="l00214"></a><span class="lineno">  214</span>        losses={}</div>
<div class="line"><a id="l00215" name="l00215"></a><span class="lineno">  215</span>        metrics={}</div>
<div class="line"><a id="l00216" name="l00216"></a><span class="lineno">  216</span>        <span class="keywordflow">for</span> name,task <span class="keywordflow">in</span> self.<a class="code hl_variable" href="a199780.html#adf5db3bb5a72111421f305a8bce645e8">tasks</a>.items():</div>
<div class="line"><a id="l00217" name="l00217"></a><span class="lineno">  217</span>            losses[name],m=task.train(self)</div>
<div class="line"><a id="l00218" name="l00218"></a><span class="lineno">  218</span>            if(len(m)&gt;0):</div>
<div class="line"><a id="l00219" name="l00219"></a><span class="lineno">  219</span>                metrics[name]=m</div>
<div class="line"><a id="l00220" name="l00220"></a><span class="lineno">  220</span>        <span class="keywordflow">return</span> losses,metrics</div>
<div class="line"><a id="l00221" name="l00221"></a><span class="lineno">  221</span> </div>
</div>
</div>
<div class="foldopen" id="foldopen00222" data-start="" data-end="">
<div class="line"><a id="l00222" name="l00222"></a><span class="lineno"><a class="line" href="a199784.html">  222</a></span><span class="keyword">class </span><a class="code hl_class" href="a199784.html">AuxiliaryTaskBase</a>:</div>
<div class="foldopen" id="foldopen00223" data-start="" data-end="">
<div class="line"><a id="l00223" name="l00223"></a><span class="lineno"><a class="line" href="a199784.html#af7537f2065d23189d9b0c8956f77f044">  223</a></span>    <span class="keyword">def </span><a class="code hl_function" href="a199784.html#af7537f2065d23189d9b0c8956f77f044">__init__</a>(self, task_name, task_config, network, hidden):</div>
<div class="line"><a id="l00224" name="l00224"></a><span class="lineno"><a class="line" href="a199784.html#a665c19f357c2a7e857c2d802769f0529">  224</a></span>        self.<a class="code hl_variable" href="a199784.html#a665c19f357c2a7e857c2d802769f0529">task_config</a> = copy.deepcopy(task_config)</div>
<div class="line"><a id="l00225" name="l00225"></a><span class="lineno"><a class="line" href="a199784.html#aaeae8ee1fad404a34e4ccd81e73c1fd5">  225</a></span>        self.<a class="code hl_variable" href="a199784.html#aaeae8ee1fad404a34e4ccd81e73c1fd5">task_name</a>=task_name</div>
<div class="line"><a id="l00226" name="l00226"></a><span class="lineno"><a class="line" href="a199784.html#a156c6ba0ae391d5c7272db4a1b968e40">  226</a></span>        self.<a class="code hl_variable" href="a199784.html#a156c6ba0ae391d5c7272db4a1b968e40">network</a> = network</div>
<div class="line"><a id="l00227" name="l00227"></a><span class="lineno"><a class="line" href="a199784.html#abc19f9697ae7b7753ed5e07fd31eaa39">  227</a></span>        self.<a class="code hl_variable" href="a199784.html#abc19f9697ae7b7753ed5e07fd31eaa39">initial_hidden</a> = hidden</div>
<div class="line"><a id="l00228" name="l00228"></a><span class="lineno"><a class="line" href="a199784.html#a54d843bca2c3900467abff772826e2c5">  228</a></span>        self.<a class="code hl_variable" href="a199784.html#a54d843bca2c3900467abff772826e2c5">batch_size</a> = task_config.get(<span class="stringliteral">&#39;batch_size&#39;</span>,128)</div>
<div class="line"><a id="l00229" name="l00229"></a><span class="lineno"><a class="line" href="a199784.html#acbd92862802a77e0ba8bd233f0c1ca4a">  229</a></span>        self.<a class="code hl_variable" href="a199784.html#acbd92862802a77e0ba8bd233f0c1ca4a">params</a> = list(self.<a class="code hl_variable" href="a199784.html#a156c6ba0ae391d5c7272db4a1b968e40">network</a>.parameters())</div>
<div class="line"><a id="l00230" name="l00230"></a><span class="lineno">  230</span>        lr=task_config.get(<span class="stringliteral">&#39;lr&#39;</span>,1e-4)</div>
<div class="line"><a id="l00231" name="l00231"></a><span class="lineno">  231</span>        weight_decay=task_config.get(<span class="stringliteral">&#39;weight_decay&#39;</span>,1e-5)</div>
<div class="line"><a id="l00232" name="l00232"></a><span class="lineno"><a class="line" href="a199784.html#a87c16c543dac294328c4cdb60b09973a">  232</a></span>        self.<a class="code hl_variable" href="a199784.html#a87c16c543dac294328c4cdb60b09973a">optimizer</a> = optim.Adam(self.<a class="code hl_variable" href="a199784.html#acbd92862802a77e0ba8bd233f0c1ca4a">params</a>, lr=lr, weight_decay=weight_decay) <span class="keywordflow">if</span> len(self.<a class="code hl_variable" href="a199784.html#acbd92862802a77e0ba8bd233f0c1ca4a">params</a>) &gt; 0 <span class="keywordflow">else</span> <span class="keywordtype">None</span></div>
</div>
<div class="foldopen" id="foldopen00233" data-start="" data-end="">
<div class="line"><a id="l00233" name="l00233"></a><span class="lineno"><a class="line" href="a199784.html#a31bc5e27a86e772a400ed5c042bd1557">  233</a></span>    <span class="keyword">def </span><a class="code hl_function" href="a199784.html#a31bc5e27a86e772a400ed5c042bd1557">select_episode_indices</a>(self, manager):</div>
<div class="line"><a id="l00234" name="l00234"></a><span class="lineno">  234</span>        candidates=manager.get_idx_candidates()</div>
<div class="line"><a id="l00235" name="l00235"></a><span class="lineno">  235</span>        <span class="keyword">def </span>selector():</div>
<div class="line"><a id="l00236" name="l00236"></a><span class="lineno">  236</span>            ep_idx=random.randrange(len(candidates))</div>
<div class="line"><a id="l00237" name="l00237"></a><span class="lineno">  237</span>            train_st=random.randrange(len(candidates[ep_idx]))</div>
<div class="line"><a id="l00238" name="l00238"></a><span class="lineno">  238</span>            <span class="keywordflow">return</span> candidates[ep_idx][train_st]</div>
<div class="line"><a id="l00239" name="l00239"></a><span class="lineno">  239</span>        <span class="keywordflow">return</span> [selector() <span class="keywordflow">for</span> i <span class="keywordflow">in</span> range(self.<a class="code hl_variable" href="a199784.html#a54d843bca2c3900467abff772826e2c5">batch_size</a>)]</div>
</div>
<div class="foldopen" id="foldopen00240" data-start="" data-end="">
<div class="line"><a id="l00240" name="l00240"></a><span class="lineno"><a class="line" href="a199784.html#a088529eec1a52521acfc1a71aa6a219a">  240</a></span>    <span class="keyword">def </span><a class="code hl_function" href="a199784.html#a088529eec1a52521acfc1a71aa6a219a">loss_and_metrics</a>(self, output, batch, manager):</div>
<div class="line"><a id="l00241" name="l00241"></a><span class="lineno">  241</span>        <span class="comment">#バッチのlossとmetrics(dict)を返す</span></div>
<div class="line"><a id="l00242" name="l00242"></a><span class="lineno">  242</span>        <span class="keywordflow">raise</span> NotImplementedError</div>
</div>
<div class="foldopen" id="foldopen00243" data-start="" data-end="">
<div class="line"><a id="l00243" name="l00243"></a><span class="lineno"><a class="line" href="a199784.html#abadb7e4832b8a7b8a1d5935c1967b16a">  243</a></span>    <span class="keyword">def </span><a class="code hl_function" href="a199784.html#abadb7e4832b8a7b8a1d5935c1967b16a">train</a>(self, manager):</div>
<div class="line"><a id="l00244" name="l00244"></a><span class="lineno">  244</span>        episodes=[manager[idx] <span class="keywordflow">for</span> idx <span class="keywordflow">in</span> self.<a class="code hl_function" href="a199784.html#a31bc5e27a86e772a400ed5c042bd1557">select_episode_indices</a>(manager)]</div>
<div class="line"><a id="l00245" name="l00245"></a><span class="lineno">  245</span>        batch=manager.make_batch(self.<a class="code hl_variable" href="a199784.html#aaeae8ee1fad404a34e4ccd81e73c1fd5">task_name</a>,episodes)</div>
<div class="line"><a id="l00246" name="l00246"></a><span class="lineno">  246</span>        batch[<span class="stringliteral">&#39;hidden_in&#39;</span>]=<a class="code hl_function" href="a197806.html#a5870da1c12de129b123fe850ed84358e">to_torch</a>(self.<a class="code hl_variable" href="a199784.html#abc19f9697ae7b7753ed5e07fd31eaa39">initial_hidden</a>)</div>
<div class="line"><a id="l00247" name="l00247"></a><span class="lineno">  247</span>        if(torch.cuda.device_count()&gt;0):</div>
<div class="line"><a id="l00248" name="l00248"></a><span class="lineno">  248</span>            batch=<a class="code hl_function" href="a197806.html#a183fe507d175130f82439ff94500f9e5">to_gpu</a>(batch)</div>
<div class="line"><a id="l00249" name="l00249"></a><span class="lineno">  249</span>        outputs=manager.forward(self.<a class="code hl_variable" href="a199784.html#a156c6ba0ae391d5c7272db4a1b968e40">network</a>,batch)</div>
<div class="line"><a id="l00250" name="l00250"></a><span class="lineno">  250</span>        loss,metrics=self.<a class="code hl_function" href="a199784.html#a088529eec1a52521acfc1a71aa6a219a">loss_and_metrics</a>(outputs,batch,manager)</div>
<div class="line"><a id="l00251" name="l00251"></a><span class="lineno">  251</span>        self.<a class="code hl_variable" href="a199784.html#a87c16c543dac294328c4cdb60b09973a">optimizer</a>.zero_grad()</div>
<div class="line"><a id="l00252" name="l00252"></a><span class="lineno">  252</span>        loss.backward()</div>
<div class="line"><a id="l00253" name="l00253"></a><span class="lineno">  253</span>        nn.utils.clip_grad_norm_(self.<a class="code hl_variable" href="a199784.html#acbd92862802a77e0ba8bd233f0c1ca4a">params</a>, 4.0)</div>
<div class="line"><a id="l00254" name="l00254"></a><span class="lineno">  254</span>        self.<a class="code hl_variable" href="a199784.html#a87c16c543dac294328c4cdb60b09973a">optimizer</a>.step()</div>
<div class="line"><a id="l00255" name="l00255"></a><span class="lineno">  255</span>        <span class="keywordflow">return</span> loss,metrics</div>
<div class="line"><a id="l00256" name="l00256"></a><span class="lineno">  256</span> </div>
</div>
</div>
<div class="foldopen" id="foldopen00257" data-start="" data-end="">
<div class="line"><a id="l00257" name="l00257"></a><span class="lineno"><a class="line" href="a199788.html">  257</a></span><span class="keyword">class </span><a class="code hl_class" href="a199788.html">AuxiliaryTaskNetworkBase</a>(nn.Module):</div>
<div class="foldopen" id="foldopen00258" data-start="" data-end="">
<div class="line"><a id="l00258" name="l00258"></a><span class="lineno"><a class="line" href="a199788.html#ab9ca9cd923e5a780b2bc002a5c726001">  258</a></span>    <span class="keyword">def </span><a class="code hl_function" href="a199788.html#ab9ca9cd923e5a780b2bc002a5c726001">__init__</a>(self, input_space, truth_space, model_classes, model_config):</div>
<div class="line"><a id="l00259" name="l00259"></a><span class="lineno">  259</span>        super().<a class="code hl_function" href="a199788.html#ab9ca9cd923e5a780b2bc002a5c726001">__init__</a>()</div>
</div>
<div class="line"><a id="l00260" name="l00260"></a><span class="lineno">  260</span>    <span class="preprocessor">@property</span></div>
<div class="foldopen" id="foldopen00261" data-start="" data-end="">
<div class="line"><a id="l00261" name="l00261"></a><span class="lineno"><a class="line" href="a199788.html#a084c0775303cda2c13fa3523bbcdb01c">  261</a></span>    <span class="keyword">def </span><a class="code hl_function" href="a199788.html#a084c0775303cda2c13fa3523bbcdb01c">output_shape</a>(self):</div>
<div class="line"><a id="l00262" name="l00262"></a><span class="lineno">  262</span>        <span class="keywordflow">raise</span> NotImplementedError</div>
</div>
<div class="foldopen" id="foldopen00263" data-start="" data-end="">
<div class="line"><a id="l00263" name="l00263"></a><span class="lineno"><a class="line" href="a199788.html#a556bebe28727abe611ca01a207817240">  263</a></span>    <span class="keyword">def </span><a class="code hl_function" href="a199788.html#a556bebe28727abe611ca01a207817240">forward</a>(self, inputs, states=None, seq_len=None, mask=None):</div>
<div class="line"><a id="l00264" name="l00264"></a><span class="lineno">  264</span>        <span class="keywordflow">raise</span> NotImplementedError</div>
</div>
<div class="foldopen" id="foldopen00265" data-start="" data-end="">
<div class="line"><a id="l00265" name="l00265"></a><span class="lineno"><a class="line" href="a199788.html#ad4aa49e2364551c6209d4a022a7a6b44">  265</a></span>    <span class="keyword">def </span><a class="code hl_function" href="a199788.html#ad4aa49e2364551c6209d4a022a7a6b44">init_hidden</a>(self, batch_size=None):</div>
<div class="line"><a id="l00266" name="l00266"></a><span class="lineno">  266</span>        <span class="keywordflow">raise</span> NotImplementedError</div>
</div>
</div>
<div class="ttc" id="aa197806_html_a183fe507d175130f82439ff94500f9e5"><div class="ttname"><a href="a197806.html#a183fe507d175130f82439ff94500f9e5">Supervised.AuxiliaryTaskUtilForHandyRL.to_gpu</a></div><div class="ttdeci">to_gpu(data)</div><div class="ttdef"><b>Definition</b> <a href="#l00023">AuxiliaryTaskUtilForHandyRL.py:23</a></div></div>
<div class="ttc" id="aa197806_html_a5870da1c12de129b123fe850ed84358e"><div class="ttname"><a href="a197806.html#a5870da1c12de129b123fe850ed84358e">Supervised.AuxiliaryTaskUtilForHandyRL.to_torch</a></div><div class="ttdeci">to_torch(x)</div><div class="ttdef"><b>Definition</b> <a href="#l00020">AuxiliaryTaskUtilForHandyRL.py:20</a></div></div>
<div class="ttc" id="aa197806_html_a9730abcd04ed275abbd43267a5e9e887"><div class="ttname"><a href="a197806.html#a9730abcd04ed275abbd43267a5e9e887">Supervised.AuxiliaryTaskUtilForHandyRL.replace_none</a></div><div class="ttdeci">replace_none(a, b)</div><div class="ttdef"><b>Definition</b> <a href="#l00026">AuxiliaryTaskUtilForHandyRL.py:26</a></div></div>
<div class="ttc" id="aa199780_html"><div class="ttname"><a href="a199780.html">Supervised.AuxiliaryTaskUtilForHandyRL.AuxiliaryTaskManager</a></div><div class="ttdef"><b>Definition</b> <a href="#l00029">AuxiliaryTaskUtilForHandyRL.py:29</a></div></div>
<div class="ttc" id="aa199780_html_a0a60f1cd30c17bb2be5ab3667051526f"><div class="ttname"><a href="a199780.html#a0a60f1cd30c17bb2be5ab3667051526f">Supervised.AuxiliaryTaskUtilForHandyRL.AuxiliaryTaskManager.add_episodes</a></div><div class="ttdeci">add_episodes(self, episodes)</div><div class="ttdef"><b>Definition</b> <a href="#l00107">AuxiliaryTaskUtilForHandyRL.py:107</a></div></div>
<div class="ttc" id="aa199780_html_a158dfcb175ae120c96b8bbf54a8130cb"><div class="ttname"><a href="a199780.html#a158dfcb175ae120c96b8bbf54a8130cb">Supervised.AuxiliaryTaskUtilForHandyRL.AuxiliaryTaskManager.ep_indices</a></div><div class="ttdeci">list ep_indices</div><div class="ttdef"><b>Definition</b> <a href="#l00048">AuxiliaryTaskUtilForHandyRL.py:48</a></div></div>
<div class="ttc" id="aa199780_html_a1deb9d315d2982bb12398a78f839950a"><div class="ttname"><a href="a199780.html#a1deb9d315d2982bb12398a78f839950a">Supervised.AuxiliaryTaskUtilForHandyRL.AuxiliaryTaskManager.extract_data</a></div><div class="ttdeci">extract_data(self, ep)</div><div class="ttdef"><b>Definition</b> <a href="#l00064">AuxiliaryTaskUtilForHandyRL.py:64</a></div></div>
<div class="ttc" id="aa199780_html_a27673a4fff542d421cee67f769197d29"><div class="ttname"><a href="a199780.html#a27673a4fff542d421cee67f769197d29">Supervised.AuxiliaryTaskUtilForHandyRL.AuxiliaryTaskManager.__init__</a></div><div class="ttdeci">__init__(self, args, model)</div><div class="ttdef"><b>Definition</b> <a href="#l00030">AuxiliaryTaskUtilForHandyRL.py:30</a></div></div>
<div class="ttc" id="aa199780_html_a2af5a32a89659aa800f6570e5568488d"><div class="ttname"><a href="a199780.html#a2af5a32a89659aa800f6570e5568488d">Supervised.AuxiliaryTaskUtilForHandyRL.AuxiliaryTaskManager.episodes</a></div><div class="ttdeci">list episodes</div><div class="ttdef"><b>Definition</b> <a href="#l00042">AuxiliaryTaskUtilForHandyRL.py:42</a></div></div>
<div class="ttc" id="aa199780_html_a2c101d6d2941ab9bf2f5f5a4593197e3"><div class="ttname"><a href="a199780.html#a2c101d6d2941ab9bf2f5f5a4593197e3">Supervised.AuxiliaryTaskUtilForHandyRL.AuxiliaryTaskManager.train</a></div><div class="ttdeci">train(self)</div><div class="ttdef"><b>Definition</b> <a href="#l00213">AuxiliaryTaskUtilForHandyRL.py:213</a></div></div>
<div class="ttc" id="aa199780_html_a3821ebdc2c9dff3432c1929915effd29"><div class="ttname"><a href="a199780.html#a3821ebdc2c9dff3432c1929915effd29">Supervised.AuxiliaryTaskUtilForHandyRL.AuxiliaryTaskManager.get_episode</a></div><div class="ttdeci">get_episode(self, ep_idx)</div><div class="ttdef"><b>Definition</b> <a href="#l00129">AuxiliaryTaskUtilForHandyRL.py:129</a></div></div>
<div class="ttc" id="aa199780_html_a3d67fe9f78b92dd308cd43f6b8588b2c"><div class="ttname"><a href="a199780.html#a3d67fe9f78b92dd308cd43f6b8588b2c">Supervised.AuxiliaryTaskUtilForHandyRL.AuxiliaryTaskManager.policy_to_train</a></div><div class="ttdeci">policy_to_train</div><div class="ttdef"><b>Definition</b> <a href="#l00040">AuxiliaryTaskUtilForHandyRL.py:40</a></div></div>
<div class="ttc" id="aa199780_html_a40650e44a8d452b40ae547149d7fa216"><div class="ttname"><a href="a199780.html#a40650e44a8d452b40ae547149d7fa216">Supervised.AuxiliaryTaskUtilForHandyRL.AuxiliaryTaskManager.make_batch</a></div><div class="ttdeci">make_batch(self, task_name, episodes)</div><div class="ttdef"><b>Definition</b> <a href="#l00148">AuxiliaryTaskUtilForHandyRL.py:148</a></div></div>
<div class="ttc" id="aa199780_html_a55092b09b7f4711fd43833e9dbd8fcc0"><div class="ttname"><a href="a199780.html#a55092b09b7f4711fd43833e9dbd8fcc0">Supervised.AuxiliaryTaskUtilForHandyRL.AuxiliaryTaskManager.model</a></div><div class="ttdeci">model</div><div class="ttdef"><b>Definition</b> <a href="#l00032">AuxiliaryTaskUtilForHandyRL.py:32</a></div></div>
<div class="ttc" id="aa199780_html_a59231da590ccbb649314e4a7bb35da12"><div class="ttname"><a href="a199780.html#a59231da590ccbb649314e4a7bb35da12">Supervised.AuxiliaryTaskUtilForHandyRL.AuxiliaryTaskManager.args</a></div><div class="ttdeci">args</div><div class="ttdef"><b>Definition</b> <a href="#l00031">AuxiliaryTaskUtilForHandyRL.py:31</a></div></div>
<div class="ttc" id="aa199780_html_a6207eddde0abb9c65862e06c5c0f63c9"><div class="ttname"><a href="a199780.html#a6207eddde0abb9c65862e06c5c0f63c9">Supervised.AuxiliaryTaskUtilForHandyRL.AuxiliaryTaskManager.flat_idx_from_ep</a></div><div class="ttdeci">flat_idx_from_ep</div><div class="ttdef"><b>Definition</b> <a href="#l00049">AuxiliaryTaskUtilForHandyRL.py:49</a></div></div>
<div class="ttc" id="aa199780_html_a649525d8b466e5bae1c2e5d77355c0cb"><div class="ttname"><a href="a199780.html#a649525d8b466e5bae1c2e5d77355c0cb">Supervised.AuxiliaryTaskUtilForHandyRL.AuxiliaryTaskManager.get_idx_candidates</a></div><div class="ttdeci">get_idx_candidates(self)</div><div class="ttdef"><b>Definition</b> <a href="#l00131">AuxiliaryTaskUtilForHandyRL.py:131</a></div></div>
<div class="ttc" id="aa199780_html_a6f308f993b6c14f39793528508a385f9"><div class="ttname"><a href="a199780.html#a6f308f993b6c14f39793528508a385f9">Supervised.AuxiliaryTaskUtilForHandyRL.AuxiliaryTaskManager.forward</a></div><div class="ttdeci">forward(self, model, batch)</div><div class="ttdef"><b>Definition</b> <a href="#l00181">AuxiliaryTaskUtilForHandyRL.py:181</a></div></div>
<div class="ttc" id="aa199780_html_a8300bfd589d70b9df2567e136366bb50"><div class="ttname"><a href="a199780.html#a8300bfd589d70b9df2567e136366bb50">Supervised.AuxiliaryTaskUtilForHandyRL.AuxiliaryTaskManager.inputs_zeros</a></div><div class="ttdeci">dict inputs_zeros</div><div class="ttdef"><b>Definition</b> <a href="#l00050">AuxiliaryTaskUtilForHandyRL.py:50</a></div></div>
<div class="ttc" id="aa199780_html_a910e8a532380740b9062313fb70ba15c"><div class="ttname"><a href="a199780.html#a910e8a532380740b9062313fb70ba15c">Supervised.AuxiliaryTaskUtilForHandyRL.AuxiliaryTaskManager.capacity</a></div><div class="ttdeci">int capacity</div><div class="ttdef"><b>Definition</b> <a href="#l00043">AuxiliaryTaskUtilForHandyRL.py:43</a></div></div>
<div class="ttc" id="aa199780_html_a9fb8a2c5549375ee361f13293aae5e29"><div class="ttname"><a href="a199780.html#a9fb8a2c5549375ee361f13293aae5e29">Supervised.AuxiliaryTaskUtilForHandyRL.AuxiliaryTaskManager._next_idx</a></div><div class="ttdeci">int _next_idx</div><div class="ttdef"><b>Definition</b> <a href="#l00045">AuxiliaryTaskUtilForHandyRL.py:45</a></div></div>
<div class="ttc" id="aa199780_html_aaa902cc6cff5982fd00c82282f50ad0f"><div class="ttname"><a href="a199780.html#aaa902cc6cff5982fd00c82282f50ad0f">Supervised.AuxiliaryTaskUtilForHandyRL.AuxiliaryTaskManager._ep_idx_ofs</a></div><div class="ttdeci">int _ep_idx_ofs</div><div class="ttdef"><b>Definition</b> <a href="#l00044">AuxiliaryTaskUtilForHandyRL.py:44</a></div></div>
<div class="ttc" id="aa199780_html_aac4ec8d53ada4ad43240eb8010e7e465"><div class="ttname"><a href="a199780.html#aac4ec8d53ada4ad43240eb8010e7e465">Supervised.AuxiliaryTaskUtilForHandyRL.AuxiliaryTaskManager._total_data_count</a></div><div class="ttdeci">int _total_data_count</div><div class="ttdef"><b>Definition</b> <a href="#l00047">AuxiliaryTaskUtilForHandyRL.py:47</a></div></div>
<div class="ttc" id="aa199780_html_adf5db3bb5a72111421f305a8bce645e8"><div class="ttname"><a href="a199780.html#adf5db3bb5a72111421f305a8bce645e8">Supervised.AuxiliaryTaskUtilForHandyRL.AuxiliaryTaskManager.tasks</a></div><div class="ttdeci">dict tasks</div><div class="ttdef"><b>Definition</b> <a href="#l00036">AuxiliaryTaskUtilForHandyRL.py:36</a></div></div>
<div class="ttc" id="aa199780_html_aec1995d16f3c04e0c1a9e0316a3c100d"><div class="ttname"><a href="a199780.html#aec1995d16f3c04e0c1a9e0316a3c100d">Supervised.AuxiliaryTaskUtilForHandyRL.AuxiliaryTaskManager._data_count</a></div><div class="ttdeci">int _data_count</div><div class="ttdef"><b>Definition</b> <a href="#l00046">AuxiliaryTaskUtilForHandyRL.py:46</a></div></div>
<div class="ttc" id="aa199780_html_afb253b7a600a7a1771e96414e9814e04"><div class="ttname"><a href="a199780.html#afb253b7a600a7a1771e96414e9814e04">Supervised.AuxiliaryTaskUtilForHandyRL.AuxiliaryTaskManager.truth_zeros</a></div><div class="ttdeci">dict truth_zeros</div><div class="ttdef"><b>Definition</b> <a href="#l00051">AuxiliaryTaskUtilForHandyRL.py:51</a></div></div>
<div class="ttc" id="aa199780_html_afd8f198150b750d7785ff27b20c930ce"><div class="ttname"><a href="a199780.html#afd8f198150b750d7785ff27b20c930ce">Supervised.AuxiliaryTaskUtilForHandyRL.AuxiliaryTaskManager.__getitem__</a></div><div class="ttdeci">__getitem__(self, idx)</div><div class="ttdef"><b>Definition</b> <a href="#l00133">AuxiliaryTaskUtilForHandyRL.py:133</a></div></div>
<div class="ttc" id="aa199784_html"><div class="ttname"><a href="a199784.html">Supervised.AuxiliaryTaskUtilForHandyRL.AuxiliaryTaskBase</a></div><div class="ttdef"><b>Definition</b> <a href="#l00222">AuxiliaryTaskUtilForHandyRL.py:222</a></div></div>
<div class="ttc" id="aa199784_html_a088529eec1a52521acfc1a71aa6a219a"><div class="ttname"><a href="a199784.html#a088529eec1a52521acfc1a71aa6a219a">Supervised.AuxiliaryTaskUtilForHandyRL.AuxiliaryTaskBase.loss_and_metrics</a></div><div class="ttdeci">loss_and_metrics(self, output, batch, manager)</div><div class="ttdef"><b>Definition</b> <a href="#l00240">AuxiliaryTaskUtilForHandyRL.py:240</a></div></div>
<div class="ttc" id="aa199784_html_a156c6ba0ae391d5c7272db4a1b968e40"><div class="ttname"><a href="a199784.html#a156c6ba0ae391d5c7272db4a1b968e40">Supervised.AuxiliaryTaskUtilForHandyRL.AuxiliaryTaskBase.network</a></div><div class="ttdeci">network</div><div class="ttdef"><b>Definition</b> <a href="#l00226">AuxiliaryTaskUtilForHandyRL.py:226</a></div></div>
<div class="ttc" id="aa199784_html_a31bc5e27a86e772a400ed5c042bd1557"><div class="ttname"><a href="a199784.html#a31bc5e27a86e772a400ed5c042bd1557">Supervised.AuxiliaryTaskUtilForHandyRL.AuxiliaryTaskBase.select_episode_indices</a></div><div class="ttdeci">select_episode_indices(self, manager)</div><div class="ttdef"><b>Definition</b> <a href="#l00233">AuxiliaryTaskUtilForHandyRL.py:233</a></div></div>
<div class="ttc" id="aa199784_html_a54d843bca2c3900467abff772826e2c5"><div class="ttname"><a href="a199784.html#a54d843bca2c3900467abff772826e2c5">Supervised.AuxiliaryTaskUtilForHandyRL.AuxiliaryTaskBase.batch_size</a></div><div class="ttdeci">batch_size</div><div class="ttdef"><b>Definition</b> <a href="#l00228">AuxiliaryTaskUtilForHandyRL.py:228</a></div></div>
<div class="ttc" id="aa199784_html_a665c19f357c2a7e857c2d802769f0529"><div class="ttname"><a href="a199784.html#a665c19f357c2a7e857c2d802769f0529">Supervised.AuxiliaryTaskUtilForHandyRL.AuxiliaryTaskBase.task_config</a></div><div class="ttdeci">task_config</div><div class="ttdef"><b>Definition</b> <a href="#l00224">AuxiliaryTaskUtilForHandyRL.py:224</a></div></div>
<div class="ttc" id="aa199784_html_a87c16c543dac294328c4cdb60b09973a"><div class="ttname"><a href="a199784.html#a87c16c543dac294328c4cdb60b09973a">Supervised.AuxiliaryTaskUtilForHandyRL.AuxiliaryTaskBase.optimizer</a></div><div class="ttdeci">int optimizer</div><div class="ttdef"><b>Definition</b> <a href="#l00232">AuxiliaryTaskUtilForHandyRL.py:232</a></div></div>
<div class="ttc" id="aa199784_html_aaeae8ee1fad404a34e4ccd81e73c1fd5"><div class="ttname"><a href="a199784.html#aaeae8ee1fad404a34e4ccd81e73c1fd5">Supervised.AuxiliaryTaskUtilForHandyRL.AuxiliaryTaskBase.task_name</a></div><div class="ttdeci">task_name</div><div class="ttdef"><b>Definition</b> <a href="#l00225">AuxiliaryTaskUtilForHandyRL.py:225</a></div></div>
<div class="ttc" id="aa199784_html_abadb7e4832b8a7b8a1d5935c1967b16a"><div class="ttname"><a href="a199784.html#abadb7e4832b8a7b8a1d5935c1967b16a">Supervised.AuxiliaryTaskUtilForHandyRL.AuxiliaryTaskBase.train</a></div><div class="ttdeci">train(self, manager)</div><div class="ttdef"><b>Definition</b> <a href="#l00243">AuxiliaryTaskUtilForHandyRL.py:243</a></div></div>
<div class="ttc" id="aa199784_html_abc19f9697ae7b7753ed5e07fd31eaa39"><div class="ttname"><a href="a199784.html#abc19f9697ae7b7753ed5e07fd31eaa39">Supervised.AuxiliaryTaskUtilForHandyRL.AuxiliaryTaskBase.initial_hidden</a></div><div class="ttdeci">initial_hidden</div><div class="ttdef"><b>Definition</b> <a href="#l00227">AuxiliaryTaskUtilForHandyRL.py:227</a></div></div>
<div class="ttc" id="aa199784_html_acbd92862802a77e0ba8bd233f0c1ca4a"><div class="ttname"><a href="a199784.html#acbd92862802a77e0ba8bd233f0c1ca4a">Supervised.AuxiliaryTaskUtilForHandyRL.AuxiliaryTaskBase.params</a></div><div class="ttdeci">params</div><div class="ttdef"><b>Definition</b> <a href="#l00229">AuxiliaryTaskUtilForHandyRL.py:229</a></div></div>
<div class="ttc" id="aa199784_html_af7537f2065d23189d9b0c8956f77f044"><div class="ttname"><a href="a199784.html#af7537f2065d23189d9b0c8956f77f044">Supervised.AuxiliaryTaskUtilForHandyRL.AuxiliaryTaskBase.__init__</a></div><div class="ttdeci">__init__(self, task_name, task_config, network, hidden)</div><div class="ttdef"><b>Definition</b> <a href="#l00223">AuxiliaryTaskUtilForHandyRL.py:223</a></div></div>
<div class="ttc" id="aa199788_html"><div class="ttname"><a href="a199788.html">Supervised.AuxiliaryTaskUtilForHandyRL.AuxiliaryTaskNetworkBase</a></div><div class="ttdef"><b>Definition</b> <a href="#l00257">AuxiliaryTaskUtilForHandyRL.py:257</a></div></div>
<div class="ttc" id="aa199788_html_a084c0775303cda2c13fa3523bbcdb01c"><div class="ttname"><a href="a199788.html#a084c0775303cda2c13fa3523bbcdb01c">Supervised.AuxiliaryTaskUtilForHandyRL.AuxiliaryTaskNetworkBase.output_shape</a></div><div class="ttdeci">output_shape(self)</div><div class="ttdef"><b>Definition</b> <a href="#l00261">AuxiliaryTaskUtilForHandyRL.py:261</a></div></div>
<div class="ttc" id="aa199788_html_a556bebe28727abe611ca01a207817240"><div class="ttname"><a href="a199788.html#a556bebe28727abe611ca01a207817240">Supervised.AuxiliaryTaskUtilForHandyRL.AuxiliaryTaskNetworkBase.forward</a></div><div class="ttdeci">forward(self, inputs, states=None, seq_len=None, mask=None)</div><div class="ttdef"><b>Definition</b> <a href="#l00263">AuxiliaryTaskUtilForHandyRL.py:263</a></div></div>
<div class="ttc" id="aa199788_html_ab9ca9cd923e5a780b2bc002a5c726001"><div class="ttname"><a href="a199788.html#ab9ca9cd923e5a780b2bc002a5c726001">Supervised.AuxiliaryTaskUtilForHandyRL.AuxiliaryTaskNetworkBase.__init__</a></div><div class="ttdeci">__init__(self, input_space, truth_space, model_classes, model_config)</div><div class="ttdef"><b>Definition</b> <a href="#l00258">AuxiliaryTaskUtilForHandyRL.py:258</a></div></div>
<div class="ttc" id="aa199788_html_ad4aa49e2364551c6209d4a022a7a6b44"><div class="ttname"><a href="a199788.html#ad4aa49e2364551c6209d4a022a7a6b44">Supervised.AuxiliaryTaskUtilForHandyRL.AuxiliaryTaskNetworkBase.init_hidden</a></div><div class="ttdeci">init_hidden(self, batch_size=None)</div><div class="ttdef"><b>Definition</b> <a href="#l00265">AuxiliaryTaskUtilForHandyRL.py:265</a></div></div>
</div><!-- fragment --></div><!-- contents -->
</div><!-- doc-content -->
</div><!-- container -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a href="dir_3e77b9d82059d338239beb58f92b2d04.html">core_plugins</a></li><li class="navelem"><a href="dir_a2e04ea9bc28d5c01dce68994d07965f.html">Supervised</a></li><li class="navelem"><a href="dir_d91068fd63318236fafe19c46806f363.html">Supervised</a></li><li class="navelem"><a href="a51689.html">AuxiliaryTaskUtilForHandyRL.py</a></li>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.14.0 </li>
  </ul>
</div>
</body>
</html>
