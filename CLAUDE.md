# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

This is a defensive air combat AI simulation environment for the 4th Air Combat AI Challenge (第4回空戦AIチャレンジ). The project contains simulation tools for developing and testing air-to-air combat AI agents in a defensive context.

## Repository Structure

- `samples/simulator_dist/` - Main simulation distribution containing:
  - `Agents/` - Agent implementation directories (BenchMark, MyAgent samples)
  - `common/` - Competition configuration files for different divisions (youth/open)
  - `dist/linux/` - Pre-built wheel packages for the simulator and dependencies
  - `dockerfiles/` - Docker environment setup (CPU and GPU versions)
  - `docs/html/` - Comprehensive documentation generated by Doxygen
  - `src/` - Core validation and testing modules
- `samples/sample_submit/` - Template structure for agent submissions

## Development Environment Setup

### Docker Environment (Recommended)
```bash
# Build and start container (GPU version by default)
docker compose up -d

# For CPU-only environment, edit docker-compose.yml to use dockerfiles/Dockerfile.cpu

# Access container
docker exec -it atla4 bash
```

### Local Environment
```bash
# Install simulator and dependencies
cd samples/simulator_dist/dist/linux
pip install -r requirements.txt
```

Required Python packages:
- torch==2.7.0
- tensorflow==2.13.0
- pandas==2.1.4
- scikit-learn==1.6.1
- lightgbm==4.5.0
- timeout-decorator==0.5.0
- opencv-python-headless==4.11.0.86

## Agent Development

### Agent Structure
Each agent must implement:
- `__init__.py` - Main agent interface with required functions:
  - `getUserAgentClass()` - Returns Agent class
  - `getUserAgentModelConfig()` - Returns model configuration
  - `isUserAgentSingleAsset()` - Returns True for single aircraft, False for team
  - `getUserPolicy()` - Returns StandalonePolicy instance
- `args.json` - Agent arguments configuration
- `config.json` - Agent behavior parameters (Fixed/Random configurations)

### Common Development Tasks

**Test agent against benchmark:**
```bash
python validate.py --myagent-id agent_name --myagent-module-path /path/to/agent --visualize 1
```

**Create submission package:**
```bash
cd Agents
zip -r submit.zip MyAgent
```

**Generate replay videos:**
```bash
python validate.py --visualize 0 --replay 1
xvfb-run python replay.py
```

**Run validation tests:**
```bash
# Basic validation (3 battles by default)
python validate.py --myagent-module-path Agents/MyAgent

# Extended validation with custom parameters
python validate.py --num-validation 10 --time-out 5.0 --memory-limit 8.0 --youth 0
```

## Configuration Options

- `--youth 1` - Youth division settings, `--youth 0` - Open division
- `--visualize 1` - Show battle visualization during execution
- `--replay 1` - Save battle replay data (.dat files)
- `--make-log 1` - Save detailed step logs (observations/actions/info)
- `--memory-limit` - Memory usage limit in GB (default: 7.5)
- `--time-out` - Action decision timeout in seconds (default: 3.0)

## Key Architecture Components

### Agent Types
- **SingleAsset**: One agent controls one aircraft
- **MultiAsset**: One agent controls entire team

### Policy Framework
All agents must implement `StandalonePolicy` with a `step()` method that processes observations and returns actions.

### Simulation Flow
1. Environment initialization with mission configurations
2. Agent registration and model loading  
3. Step-by-step simulation with observation→action cycles
4. Battle conclusion with scoring and statistics

## Performance Considerations

- Agents must respond within timeout limits (default 3 seconds)
- Memory usage is monitored and limited (default 7.5 GB)
- Log data is size-limited (default 0.08 GB per battle)
- Evaluation runs on CPU-only environment

## Documentation

Comprehensive documentation available at `samples/simulator_dist/docs/html/core/index.html` covering:
- Environment setup procedures
- Simulation mechanics and APIs
- Learning framework integration (HandyRL)
- Plugin system architecture
- Competition-specific tutorials